<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - ParkaLot</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; color: #333; background: #f9fafb; min-height: 100vh; }

    .navbar { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
    .navbar-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .navbar-brand span { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; color: #2563eb; }
    .navbar-menu { display: flex; gap: 25px; list-style: none; align-items: center; }
    .navbar-menu a { color: #333; text-decoration: none; font-weight: 600; font-size: 15px; }
    .navbar-menu a:hover { color: #2563eb; }
    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; font-size: 15px; border: none; transition: all 0.3s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-outline { background: transparent; color: #2563eb; border: 2px solid #2563eb; }
    .btn-outline:hover { background: #2563eb; color: white; }

    .profile-container { max-width: 900px; margin: 0 auto; padding: 40px 5%; }

    .profile-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .profile-avatar {
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      border: 4px solid rgba(255,255,255,0.3);
    }
    .profile-info h1 { font-family: 'Poppins', sans-serif; font-size: 28px; margin-bottom: 8px; }
    .profile-info p { opacity: 0.9; }
    .profile-badges { display: flex; gap: 10px; margin-top: 12px; }
    .badge {
      background: rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.verified { background: #10b981; }
    .badge.owner { background: #f59e0b; }

    .profile-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .section-header h2 { font-family: 'Poppins', sans-serif; font-size: 20px; display: flex; align-items: center; gap: 10px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #2563eb;
    }
    .form-group input:disabled {
      background: #f3f4f6;
      color: #6b7280;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    .form-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .form-message.success { background: #f0fdf4; color: #059669; border: 1px solid #10b981; }
    .form-message.error { background: #fef2f2; color: #dc2626; border: 1px solid #ef4444; }

    .earnings-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .earnings-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .earnings-card .value { font-size: 28px; font-weight: 700; color: #059669; }
    .earnings-card .label { font-size: 13px; color: #6b7280; margin-top: 4px; }

    .payout-status {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .payout-status .icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .payout-status.pending .icon { background: #fef3c7; }
    .payout-status.complete .icon { background: #d1fae5; }
    .payout-status.not-setup .icon { background: #fee2e2; }

    .bank-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: #f9fafb;
      border-radius: 10px;
    }
    .bank-info .details { display: flex; align-items: center; gap: 12px; }
    .bank-info .bank-icon { font-size: 24px; }

    .danger-zone {
      border: 2px solid #fecaca;
      background: #fef2f2;
    }
    .danger-zone h2 { color: #dc2626; }

    @media (max-width: 768px) {
      .profile-header { flex-direction: column; text-align: center; }
      .form-row { grid-template-columns: 1fr; }
      .earnings-summary { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <a href="home.html" class="navbar-brand">
    <img src="images/logo.svg" alt="ParkaLot" height="40">
    <span>ParkaLot</span>
  </a>
  <ul class="navbar-menu">
    <li><a href="find-parking.html">Find Parking</a></li>
    <li><a href="space-gallery.html">Gallery</a></li>
    <li><a href="customer_dashboard.html">Dashboard</a></li>
    <li><a href="profile.html" class="btn btn-outline" style="padding: 8px 16px;">My Profile</a></li>
  </ul>
</nav>

<div class="profile-container">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-avatar" id="profileAvatar">üë§</div>
    <div class="profile-info">
      <h1 id="profileName">Loading...</h1>
      <p id="profileEmail">Loading...</p>
      <div class="profile-badges">
        <span class="badge" id="emailBadge" style="display: none;">Email Verified</span>
        <span class="badge owner" id="ownerBadge" style="display: none;">Space Owner</span>
      </div>
    </div>
  </div>

  <!-- Basic Information -->
  <div class="profile-section">
    <div class="section-header">
      <h2>üë§ Basic Information</h2>
    </div>
    <div id="profileMsg" class="form-message" style="display: none;"></div>
    <form id="profileForm" onsubmit="updateProfile(event)">
      <div class="form-row">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="fullName" required minlength="2">
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="email" disabled>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Phone Number (Optional)</label>
          <input type="tel" id="phone" placeholder="+44 7XXX XXXXXX">
        </div>
        <div class="form-group">
          <label>Member Since</label>
          <input type="text" id="memberSince" disabled>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
  </div>

  <!-- Change Password -->
  <div class="profile-section">
    <div class="section-header">
      <h2>üîí Change Password</h2>
    </div>
    <div id="passwordMsg" class="form-message" style="display: none;"></div>
    <form onsubmit="changePassword(event)">
      <div class="form-group">
        <label>Current Password</label>
        <input type="password" id="currentPassword" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" required minlength="8">
        </div>
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPassword" required>
        </div>
      </div>
      <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">
        Password must be at least 8 characters with uppercase, lowercase, and a number.
      </p>
      <button type="submit" class="btn btn-primary">Update Password</button>
    </form>
  </div>

  <!-- Space Owner Section (conditionally shown) -->
  <div class="profile-section" id="ownerSection" style="display: none;">
    <div class="section-header">
      <h2>üí∞ Space Owner Earnings</h2>
      <a href="customer_dashboard.html" class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;">View Full Dashboard</a>
    </div>

    <div class="earnings-summary">
      <div class="earnings-card">
        <div class="value" id="ownerTotalEarnings">¬£0.00</div>
        <div class="label">Total Earnings</div>
      </div>
      <div class="earnings-card">
        <div class="value" id="ownerPendingPayout">¬£0.00</div>
        <div class="label">Pending Payout</div>
      </div>
      <div class="earnings-card">
        <div class="value" id="ownerTotalSpaces">0</div>
        <div class="label">Listed Spaces</div>
      </div>
    </div>

    <!-- Payout Setup -->
    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Payout Settings</h3>

    <div class="payout-status not-setup" id="payoutStatus">
      <div class="icon">üí≥</div>
      <div>
        <div style="font-weight: 600;" id="payoutStatusTitle">Payout Not Set Up</div>
        <div style="font-size: 13px; color: #6b7280;" id="payoutStatusDesc">Connect your bank account to receive earnings</div>
      </div>
    </div>

    <div id="bankInfo" style="display: none;">
      <div class="bank-info">
        <div class="details">
          <span class="bank-icon">üè¶</span>
          <div>
            <div style="font-weight: 600;">Bank Account</div>
            <div style="font-size: 13px; color: #6b7280;">**** **** **** <span id="bankLast4">0000</span></div>
          </div>
        </div>
        <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="updatePayoutMethod()">Update</button>
      </div>
    </div>

    <button class="btn btn-success" id="setupPayoutBtn" onclick="setupPayout()" style="margin-top: 16px;">
      Set Up Payouts
    </button>
  </div>

  <!-- Danger Zone -->
  <div class="profile-section danger-zone">
    <div class="section-header">
      <h2>‚ö†Ô∏è Danger Zone</h2>
    </div>
    <p style="margin-bottom: 16px; color: #6b7280;">
      Once you delete your account, there is no going back. Please be certain.
    </p>
    <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete My Account</button>
  </div>
</div>

<script>
  const API = "../api/index.php";

  // Load profile data
  async function loadProfile() {
    try {
      const res = await fetch(API + "?route=profile", { credentials: "same-origin" });
      const data = await res.json();

      if (data.error === "Not authenticated" || !res.ok) {
        window.location.href = "index.html";
        return;
      }

      if (data.success && data.profile) {
        const profile = data.profile;

        // Update header
        document.getElementById("profileName").textContent = profile.full_name || "User";
        document.getElementById("profileEmail").textContent = profile.email || "";
        document.getElementById("profileAvatar").textContent = (profile.full_name || "U").charAt(0).toUpperCase();

        // Update form
        document.getElementById("fullName").value = profile.full_name || "";
        document.getElementById("email").value = profile.email || "";
        document.getElementById("phone").value = profile.phone || "";

        if (profile.created_at) {
          const date = new Date(profile.created_at);
          document.getElementById("memberSince").value = date.toLocaleDateString('en-GB', {
            year: 'numeric', month: 'long', day: 'numeric'
          });
        }

        // Show badges
        if (profile.email_verified) {
          document.getElementById("emailBadge").style.display = "inline-block";
          document.getElementById("emailBadge").classList.add("verified");
        }

        // Check if space owner
        if (profile.is_space_owner) {
          document.getElementById("ownerBadge").style.display = "inline-block";
          document.getElementById("ownerSection").style.display = "block";
          loadOwnerEarnings();
          checkPayoutStatus();
        }
      }
    } catch (e) {
      console.error("Failed to load profile:", e);
    }
  }

  // Update profile
  async function updateProfile(e) {
    e.preventDefault();
    const msgEl = document.getElementById("profileMsg");

    const data = {
      full_name: document.getElementById("fullName").value,
      phone: document.getElementById("phone").value
    };

    try {
      const res = await fetch(API + "?route=profile", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (result.success) {
        showMessage(msgEl, "Profile updated successfully!", "success");
        document.getElementById("profileName").textContent = data.full_name;
      } else {
        showMessage(msgEl, result.error || "Failed to update profile", "error");
      }
    } catch (e) {
      showMessage(msgEl, "Network error. Please try again.", "error");
    }
  }

  // Change password
  async function changePassword(e) {
    e.preventDefault();
    const msgEl = document.getElementById("passwordMsg");

    const currentPassword = document.getElementById("currentPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (newPassword !== confirmPassword) {
      showMessage(msgEl, "New passwords do not match", "error");
      return;
    }

    if (newPassword.length < 8) {
      showMessage(msgEl, "Password must be at least 8 characters", "error");
      return;
    }

    try {
      const res = await fetch(API + "?route=profile/password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
      });
      const result = await res.json();

      if (result.success) {
        showMessage(msgEl, "Password changed successfully!", "success");
        document.getElementById("currentPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
      } else {
        showMessage(msgEl, result.error || "Failed to change password", "error");
      }
    } catch (e) {
      showMessage(msgEl, "Network error. Please try again.", "error");
    }
  }

  // Load owner earnings
  async function loadOwnerEarnings() {
    try {
      const res = await fetch(API + "?route=my-earnings", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.earnings) {
        document.getElementById("ownerTotalEarnings").textContent = "¬£" + parseFloat(data.earnings.total_earnings || 0).toFixed(2);
        document.getElementById("ownerPendingPayout").textContent = "¬£" + parseFloat(data.earnings.pending_payout || 0).toFixed(2);
        document.getElementById("ownerTotalSpaces").textContent = data.earnings.total_spaces || 0;
      }
    } catch (e) {
      console.error("Failed to load earnings:", e);
    }
  }

  // Check payout status
  async function checkPayoutStatus() {
    try {
      const res = await fetch(API + "?route=profile/stripe-status", { credentials: "same-origin" });
      const data = await res.json();

      const statusEl = document.getElementById("payoutStatus");
      const titleEl = document.getElementById("payoutStatusTitle");
      const descEl = document.getElementById("payoutStatusDesc");
      const bankEl = document.getElementById("bankInfo");
      const setupBtn = document.getElementById("setupPayoutBtn");

      if (data.success && data.stripe_status) {
        if (data.stripe_status === "complete") {
          statusEl.className = "payout-status complete";
          statusEl.querySelector(".icon").textContent = "‚úÖ";
          titleEl.textContent = "Payouts Active";
          descEl.textContent = "Your bank account is connected and ready to receive earnings";
          setupBtn.style.display = "none";

          if (data.bank_last4) {
            bankEl.style.display = "block";
            document.getElementById("bankLast4").textContent = data.bank_last4;
          }
        } else if (data.stripe_status === "pending") {
          statusEl.className = "payout-status pending";
          statusEl.querySelector(".icon").textContent = "‚è≥";
          titleEl.textContent = "Verification Pending";
          descEl.textContent = "Your account is being verified. This usually takes 1-2 business days.";
          setupBtn.textContent = "Complete Setup";
        }
      }
    } catch (e) {
      console.error("Failed to check payout status:", e);
    }
  }

  // Setup payout (Stripe Connect)
  async function setupPayout() {
    try {
      const res = await fetch(API + "?route=profile/stripe-onboard", {
        method: "POST",
        credentials: "same-origin"
      });
      const data = await res.json();

      if (data.success && data.onboarding_url) {
        window.location.href = data.onboarding_url;
      } else {
        alert(data.error || "Failed to start payout setup. Please try again.");
      }
    } catch (e) {
      alert("Network error. Please try again.");
    }
  }

  // Update payout method
  function updatePayoutMethod() {
    setupPayout();
  }

  // Confirm delete account
  function confirmDeleteAccount() {
    if (confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
      if (confirm("This will permanently delete all your data, bookings, and listings. Type 'DELETE' to confirm.")) {
        const confirmation = prompt("Type DELETE to confirm:");
        if (confirmation === "DELETE") {
          deleteAccount();
        }
      }
    }
  }

  // Delete account
  async function deleteAccount() {
    try {
      const res = await fetch(API + "?route=profile", {
        method: "DELETE",
        credentials: "same-origin"
      });
      const data = await res.json();

      if (data.success) {
        alert("Your account has been deleted. We're sorry to see you go!");
        window.location.href = "index.html";
      } else {
        alert(data.error || "Failed to delete account. Please contact support.");
      }
    } catch (e) {
      alert("Network error. Please try again.");
    }
  }

  // Show message helper
  function showMessage(el, text, type) {
    el.textContent = text;
    el.className = "form-message " + type;
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 5000);
  }

  // Initialize
  loadProfile();
</script>

</body>
</html>
