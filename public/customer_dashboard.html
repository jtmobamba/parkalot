<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ParkaLot</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; color: #333; background: #f9fafb; min-height: 100vh; }

    .navbar { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
    .navbar-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .navbar-brand span { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; color: #2563eb; }
    .navbar-menu { display: flex; gap: 25px; list-style: none; align-items: center; }
    .navbar-menu a { color: #333; text-decoration: none; font-weight: 600; font-size: 15px; }
    .navbar-menu a:hover { color: #2563eb; }
    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; font-size: 15px; border: none; transition: all 0.3s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-outline { background: transparent; color: #2563eb; border: 2px solid #2563eb; }
    .btn-outline:hover { background: #2563eb; color: white; }

    .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 30px 5%; }

    .welcome-section {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .welcome-content h1 { font-family: 'Poppins', sans-serif; font-size: 32px; margin-bottom: 10px; }
    .welcome-content p { font-size: 16px; opacity: 0.9; }
    .welcome-avatar {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 15px;
      padding: 12px;
    }
    .stat-icon img { width: 100%; height: 100%; object-fit: contain; }
    .stat-icon.blue { background: #eff6ff; }
    .stat-icon.green { background: #f0fdf4; }
    .stat-icon.orange { background: #fff7ed; }
    .welcome-avatar img { width: 100%; height: 100%; object-fit: contain; filter: brightness(0) invert(1); }
    .stat-value {
      font-family: 'Poppins', sans-serif;
      font-size: 36px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }
    .stat-label { color: #6b7280; font-size: 14px; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    .dashboard-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .dashboard-card.full-width { grid-column: span 2; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-header h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-badge {
      background: #eff6ff;
      color: #2563eb;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .card-badge.ai { background: #f0fdf4; color: #059669; }

    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Nunito', sans-serif;
      transition: border-color 0.3s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2563eb;
    }
    .form-group textarea { min-height: 100px; resize: vertical; }

    .form-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: none;
    }
    .form-message.success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .form-message.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    /* Recommendations */
    .recommendations-list { display: flex; flex-direction: column; gap: 15px; }
    .recommendation-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .recommendation-card:hover {
      border-color: #2563eb;
      transform: translateY(-2px);
    }
    .recommendation-card.featured {
      border-color: #f59e0b;
      background: linear-gradient(to right, #fffbeb, #f9fafb);
    }
    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .recommendation-header h4 { font-size: 16px; font-weight: 600; color: #1f2937; }
    .match-score {
      background: #2563eb;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .match-score.high { background: #10b981; }
    .match-score.featured { background: #f59e0b; }
    .recommendation-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      color: #6b7280;
    }
    .recommendation-details span { display: flex; align-items: center; gap: 6px; }
    .reason-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
    .reason-tag {
      background: #eff6ff;
      color: #2563eb;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
    }
    .select-garage-btn {
      width: 100%;
      padding: 10px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .select-garage-btn:hover { background: #1d4ed8; }

    /* Star Rating */
    .star-rating { display: flex; gap: 8px; margin: 10px 0; }
    .star-rating .star {
      font-size: 32px;
      color: #e5e7eb;
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
    }
    .star-rating .star:hover,
    .star-rating .star.active { color: #f59e0b; transform: scale(1.1); }
    .star-rating .star.hovered { color: #fbbf24; }

    /* Reviews List */
    .reviews-list { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
    .review-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 20px;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .review-garage-name { font-weight: 600; color: #1f2937; }
    .review-stars { color: #f59e0b; font-size: 14px; }
    .review-text { color: #6b7280; font-size: 14px; line-height: 1.6; margin-bottom: 8px; }
    .review-date { font-size: 12px; color: #9ca3af; }
    .no-reviews { text-align: center; color: #9ca3af; padding: 40px; }

    /* Loading */
    .loading-spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 20px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: #374151;
    }
    .quick-action-btn:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    .quick-action-btn span:first-child { font-size: 28px; }
    .quick-action-btn span:last-child { font-size: 14px; font-weight: 600; }

    @media (max-width: 992px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .dashboard-card.full-width { grid-column: span 1; }
      .stats-grid { grid-template-columns: 1fr; }
      .welcome-section { flex-direction: column; text-align: center; gap: 20px; }
      .quick-actions { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 576px) {
      .quick-actions { grid-template-columns: 1fr !important; }
    }
    @media (max-width: 768px) {
      .navbar-menu { display: none; }
      .navbar-menu.active { display: flex; flex-direction: column; position: absolute; top: 60px; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); gap: 15px; }
      .recommendation-details { grid-template-columns: 1fr; }
      .mobile-menu-btn { display: flex !important; }
    }
    .mobile-menu-btn { display: none; background: none; border: none; font-size: 28px; cursor: pointer; padding: 5px; }
  </style>
</head>
<body>

  <nav class="navbar">
    <a href="home.html" class="navbar-brand"><span>ParkaLot</span></a>
    <ul class="navbar-menu" id="navbarMenu">
      <li><a href="find-parking.html">Find Parking</a></li>
      <li><a href="space-gallery.html">Space Gallery</a></li>
      <li><a href="invoice.html">My Bookings</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="#" onclick="logout(); return false;">Logout</a></li>
    </ul>
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
  </nav>

  <script>
    function toggleMobileMenu() {
      document.getElementById('navbarMenu').classList.toggle('active');
    }
  </script>

  <div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
      <div class="welcome-content">
        <h1>Welcome back, <span id="userName">Customer</span>!</h1>
        <p>Manage your parking bookings and discover new spaces</p>
      </div>
      <div class="welcome-avatar"><img src="images/icons/user.svg" alt="User"></div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="quickStats" style="grid-template-columns: repeat(4, 1fr);">
      <div class="stat-card">
        <div class="stat-icon blue"><img src="images/icons/calendar.svg" alt="Calendar"></div>
        <div class="stat-value" id="totalReservations">0</div>
        <div class="stat-label">Total Bookings</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><img src="images/icons/location.svg" alt="Location"></div>
        <div class="stat-value" id="activeReservations">0</div>
        <div class="stat-label">Active Bookings</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange"><img src="images/icons/money.svg" alt="Money"></div>
        <div class="stat-value">¬£<span id="totalSpent">0.00</span></div>
        <div class="stat-label">Total Spent</div>
      </div>
      <div class="stat-card" id="earningsCard" style="display: none;">
        <div class="stat-icon" style="background: #f0fdf4;"><img src="images/icons/money.svg" alt="Earnings" style="filter: hue-rotate(90deg);"></div>
        <div class="stat-value" style="color: #10b981;">¬£<span id="totalEarnings">0.00</span></div>
        <div class="stat-label">Space Earnings</div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- AI Recommendations -->
      <div class="dashboard-card">
        <div class="card-header">
          <h2>ü§ñ Recommended For You</h2>
          <span class="card-badge ai">AI Powered</span>
        </div>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Based on your preferences and booking history</p>
        <div class="recommendations-list" id="recommendationsContainer">
          <div class="loading-spinner"></div>
        </div>
      </div>

      <!-- New Reservation -->
      <div class="dashboard-card">
        <div class="card-header">
          <h2>üé´ Book a Space</h2>
        </div>
        <form onsubmit="reserve(); return false;">
          <div class="form-group">
            <label>Select Garage</label>
            <select id="garage_id" required>
              <option value="">Choose a parking space...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Start Time</label>
            <input id="start_time" type="datetime-local" required>
          </div>
          <div class="form-group">
            <label>End Time</label>
            <input id="end_time" type="datetime-local" required>
          </div>
          <div id="reserve_msg" class="form-message"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%;" id="reserveBtn">
            Book Now
          </button>
        </form>
      </div>

      <!-- Quick Actions -->
      <div class="dashboard-card">
        <div class="card-header">
          <h2>‚ö° Quick Actions</h2>
        </div>
        <div class="quick-actions" style="grid-template-columns: repeat(3, 1fr);">
          <a href="find-parking.html" class="quick-action-btn">
            <span>üîç</span>
            <span>Find Parking</span>
          </a>
          <a href="airport-parking.html" class="quick-action-btn">
            <span>‚úàÔ∏è</span>
            <span>Airport Parking</span>
          </a>
          <a href="space-gallery.html" class="quick-action-btn">
            <span>üñºÔ∏è</span>
            <span>Space Gallery</span>
          </a>
          <a href="list-your-space.html" class="quick-action-btn" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-color: #10b981;">
            <span>üí∞</span>
            <span>List Your Space</span>
          </a>
          <a href="profile.html" class="quick-action-btn">
            <span>üë§</span>
            <span>My Profile</span>
          </a>
          <a href="invoice.html" class="quick-action-btn">
            <span>üìã</span>
            <span>My Bookings</span>
          </a>
        </div>
      </div>

      <!-- My Spaces Section (for space owners) -->
      <div class="dashboard-card" id="mySpacesSection" style="display: none;">
        <div class="card-header">
          <h2>üÖøÔ∏è My Parking Spaces</h2>
          <a href="list-your-space.html" class="btn btn-success" style="padding: 8px 16px; font-size: 13px;">+ Add New</a>
        </div>
        <div id="mySpacesList">
          <p style="color: #6b7280; text-align: center; padding: 20px;">Loading your spaces...</p>
        </div>
      </div>

      <!-- Enhanced Earnings Dashboard (for space owners) -->
      <div class="dashboard-card full-width" id="earningsDashboard" style="display: none;">
        <div class="card-header">
          <h2>üí∞ Earnings Dashboard</h2>
          <div style="display: flex; gap: 10px;">
            <select id="earningsPeriod" onchange="loadEarningsByPeriod()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px;">
              <option value="month">Monthly</option>
              <option value="week">Weekly</option>
              <option value="year">Yearly</option>
            </select>
            <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="exportEarnings()">Export CSV</button>
          </div>
        </div>

        <!-- Earnings Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #059669;" id="dashTotalEarnings">¬£0.00</div>
            <div style="font-size: 12px; color: #6b7280;">Total Earnings</div>
          </div>
          <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #2563eb;" id="dashMonthEarnings">¬£0.00</div>
            <div style="font-size: 12px; color: #6b7280;">This Month</div>
          </div>
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #d97706;" id="dashPendingPayout">¬£0.00</div>
            <div style="font-size: 12px; color: #6b7280;">Pending Payout</div>
          </div>
          <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 24px; font-weight: 700; color: #7c3aed;" id="dashTotalBookings">0</div>
            <div style="font-size: 12px; color: #6b7280;">Total Bookings</div>
          </div>
        </div>

        <!-- Earnings Chart -->
        <div style="background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Earnings Over Time</h3>
          <canvas id="earningsChart" height="200"></canvas>
        </div>

        <!-- Earnings by Space -->
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Earnings by Space</h3>
          <div id="earningsBySpaceList">
            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading...</p>
          </div>
        </div>

        <!-- Recent Bookings Table -->
        <div>
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Recent Bookings</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead>
                <tr style="background: #f3f4f6;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Space</th>
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Renter</th>
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Date</th>
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Status</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">Earnings</th>
                </tr>
              </thead>
              <tbody id="recentBookingsTable">
                <tr><td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div style="text-align: center; margin-top: 16px;">
            <button class="btn btn-outline" id="loadMoreBookings" onclick="loadMoreBookings()" style="display: none;">Load More</button>
          </div>
        </div>
      </div>

      <!-- Write a Review -->
      <div class="dashboard-card" id="reviewSection">
        <div class="card-header">
          <h2>‚≠ê Write a Review</h2>
        </div>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Share your parking experience</p>

        <div class="form-group">
          <label>Select Garage</label>
          <select id="review_garage_id">
            <option value="">Choose a garage to review...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Your Rating</label>
          <div class="star-rating" id="starRating">
            <span class="star" data-rating="1">&#9733;</span>
            <span class="star" data-rating="2">&#9733;</span>
            <span class="star" data-rating="3">&#9733;</span>
            <span class="star" data-rating="4">&#9733;</span>
            <span class="star" data-rating="5">&#9733;</span>
          </div>
          <input type="hidden" id="selected_rating" value="0">
        </div>

        <div class="form-group">
          <label>Your Review</label>
          <textarea id="review_text" placeholder="Tell us about your experience..."></textarea>
        </div>

        <div id="review_msg" class="form-message"></div>
        <button class="btn btn-success" onclick="submitReview()" style="width: 100%;">
          Submit Review
        </button>
      </div>

      <!-- Your Reviews -->
      <div class="dashboard-card full-width">
        <div class="card-header">
          <h2>üìù Your Reviews</h2>
        </div>
        <div class="reviews-list" id="reviewsList">
          <div class="no-reviews">Loading your reviews...</div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-outline" onclick="goToInvoice()">View Full Booking History</button>
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

<script>
  const API = "../api/index.php";
</script>
<script src="js/app.js"></script>
<script>
  // Load user info and stats on page load
  async function loadUserInfo() {
    try {
      const res = await fetch(API + "?route=me", { credentials: "same-origin" });
      const data = await res.json();

      if (data.user_name) {
        document.getElementById("userName").textContent = data.user_name;
      }
      if (data.role && data.role !== 'customer') {
        window.location.href = `${data.role}_dashboard.html`;
      }
    } catch (e) {
      console.error("Failed to load user info:", e);
    }
  }

  // Load AI recommendations
  async function loadRecommendations() {
    const container = document.getElementById("recommendationsContainer");

    try {
      const res = await fetch(API + "?route=recommendations", { credentials: "same-origin" });
      const data = await res.json();

      if (data.recommendations && data.recommendations.length > 0) {
        container.innerHTML = "";

        data.recommendations.slice(0, 3).forEach((rec, index) => {
          const isFeatured = index === 0;
          const card = createRecommendationCard(rec, isFeatured);
          container.appendChild(card);
        });
      } else {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No recommendations available. Book a space to get personalized suggestions!</p>';
      }
    } catch (e) {
      console.error("Failed to load recommendations:", e);
      container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Unable to load recommendations.</p>';
    }
  }

  // Create recommendation card HTML
  function createRecommendationCard(rec, isFeatured) {
    const card = document.createElement("div");
    card.className = "recommendation-card" + (isFeatured ? " featured" : "");

    const scoreClass = rec.recommendation_score >= 80 ? "high" : (isFeatured ? "featured" : "");

    card.innerHTML = `
      <div class="recommendation-header">
        <h4>${isFeatured ? 'üèÜ ' : ''}${rec.garage_name}</h4>
        <span class="match-score ${scoreClass}">${rec.recommendation_score}% Match</span>
      </div>

      <div class="recommendation-details">
        <span>üìç ${rec.location}</span>
        <span>üí∑ ¬£${rec.price_per_hour}/hr</span>
        <span>‚≠ê ${rec.rating}/5.0</span>
        <span>üÖøÔ∏è ${rec.total_spaces} spaces</span>
      </div>

      <div class="reason-tags">
        ${rec.recommendation_reasons.slice(0, 3).map(r => `<span class="reason-tag">${r}</span>`).join("")}
      </div>

      <button class="select-garage-btn" onclick="selectGarage(${rec.garage_id}, '${rec.garage_name.replace(/'/g, "\\'")}', ${rec.recommendation_score})">
        Select This Space
      </button>
    `;

    return card;
  }

  // Select a garage from recommendations
  function selectGarage(garageId, garageName, score) {
    const select = document.getElementById("garage_id");
    select.value = garageId;

    // Scroll to reservation form
    document.querySelector("#garage_id").closest(".dashboard-card").scrollIntoView({ behavior: "smooth" });

    // Log the selection for AI learning
    fetch(API + "?route=recommendations", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ garage_id: garageId, score: score })
    }).catch(e => console.error("Failed to log selection:", e));

    showMessage(document.getElementById("reserve_msg"),
                `Selected: ${garageName} - Now choose your dates!`, "success");
  }

  // Load invoice stats
  async function loadStats() {
    try {
      const res = await fetch(API + "?route=invoice", { credentials: "same-origin" });
      const data = await res.json();

      if (data.count !== undefined) {
        document.getElementById("totalReservations").textContent = data.count;
        document.getElementById("totalSpent").textContent = parseFloat(data.total || 0).toFixed(2);

        const active = data.reservations ?
          data.reservations.filter(r => r.status === 'active').length : 0;
        document.getElementById("activeReservations").textContent = active;
      }
    } catch (e) {
      console.error("Failed to load stats:", e);
    }
  }

  function showMessage(element, message, type = "error") {
    if (!element) return;
    element.style.display = "block";
    element.textContent = message;
    element.className = "form-message " + type;
  }

  // Check authentication before loading dashboard
  async function checkAuth() {
    try {
      const res = await fetch(API + "?route=me", { credentials: "same-origin" });
      if (!res.ok) {
        window.location.href = "index.html";
        return false;
      }
      return true;
    } catch (err) {
      console.error("Auth check failed:", err);
      window.location.href = "index.html";
      return false;
    }
  }

  // Initialize dashboard
  async function initDashboard() {
    const isAuth = await checkAuth();
    if (isAuth) {
      if (typeof loadGarages === "function") loadGarages();
      loadUserInfo();
      loadRecommendations();
      loadStats();
      loadReviewGarages();
      loadUserReviews();
      initStarRating();
      initDateTimeInputs();
      loadMySpaces();
      loadEnhancedEarnings(); // Use enhanced earnings dashboard
    }
  }

  // Load user's parking spaces
  async function loadMySpaces() {
    try {
      const res = await fetch(API + "?route=my-spaces", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.spaces && data.spaces.length > 0) {
        document.getElementById("mySpacesSection").style.display = "block";
        renderMySpaces(data.spaces);
      }
    } catch (e) {
      console.error("Failed to load spaces:", e);
    }
  }

  // Render spaces list
  function renderMySpaces(spaces) {
    const container = document.getElementById("mySpacesList");

    container.innerHTML = spaces.slice(0, 3).map(space => {
      const statusColors = {
        active: { bg: '#f0fdf4', color: '#059669', text: 'Active' },
        pending: { bg: '#fffbeb', color: '#d97706', text: 'Pending' },
        paused: { bg: '#f3f4f6', color: '#6b7280', text: 'Paused' }
      };
      const status = statusColors[space.status] || statusColors.pending;

      return `
        <div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">${space.space_name}</h4>
            <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
              ${space.city} ¬∑ ¬£${parseFloat(space.price_per_hour).toFixed(2)}/hr
            </p>
            <span style="background: ${status.bg}; color: ${status.color}; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">
              ${status.text}
            </span>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 18px; font-weight: 700; color: #10b981;">¬£${parseFloat(space.total_earnings || 0).toFixed(2)}</div>
            <div style="font-size: 11px; color: #6b7280;">${space.total_bookings || 0} bookings</div>
          </div>
        </div>
      `;
    }).join('');

    if (spaces.length > 3) {
      container.innerHTML += `
        <a href="list-your-space.html" style="display: block; text-align: center; color: #2563eb; font-weight: 600; padding: 12px;">
          View all ${spaces.length} spaces ‚Üí
        </a>
      `;
    }
  }

  // Load earnings summary
  async function loadEarnings() {
    try {
      const res = await fetch(API + "?route=my-earnings", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.earnings) {
        const earnings = data.earnings;
        if (earnings.total_earnings > 0 || earnings.total_spaces > 0) {
          document.getElementById("earningsCard").style.display = "block";
          document.getElementById("totalEarnings").textContent = parseFloat(earnings.total_earnings).toFixed(2);
        }
      }
    } catch (e) {
      console.error("Failed to load earnings:", e);
    }
  }

  // Initialize datetime inputs with minimum values
  function initDateTimeInputs() {
    const startInput = document.getElementById("start_time");
    const endInput = document.getElementById("end_time");

    if (startInput && endInput) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      const minDateTime = now.toISOString().slice(0, 16);

      startInput.min = minDateTime;
      endInput.min = minDateTime;

      startInput.addEventListener("change", function() {
        if (this.value) {
          endInput.min = this.value;
          if (endInput.value && endInput.value <= this.value) {
            endInput.value = "";
          }
        }
      });
    }
  }

  // Initialize star rating functionality
  function initStarRating() {
    const starContainer = document.getElementById("starRating");
    const stars = starContainer.querySelectorAll(".star");
    const ratingInput = document.getElementById("selected_rating");

    stars.forEach(star => {
      star.addEventListener("click", function() {
        const rating = parseInt(this.dataset.rating);
        ratingInput.value = rating;
        updateStars(rating);
      });

      star.addEventListener("mouseenter", function() {
        const rating = parseInt(this.dataset.rating);
        highlightStars(rating);
      });

      star.addEventListener("mouseleave", function() {
        const currentRating = parseInt(ratingInput.value) || 0;
        updateStars(currentRating);
      });
    });
  }

  function updateStars(rating) {
    const stars = document.querySelectorAll("#starRating .star");
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add("active");
      } else {
        star.classList.remove("active");
      }
      star.classList.remove("hovered");
    });
  }

  function highlightStars(rating) {
    const stars = document.querySelectorAll("#starRating .star");
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add("hovered");
      } else {
        star.classList.remove("hovered");
      }
    });
  }

  // Load garages for review dropdown
  async function loadReviewGarages() {
    const select = document.getElementById("review_garage_id");
    try {
      const { res, data } = await apiGet("/garages");
      const garages = data && data.garages;

      if (res.ok && Array.isArray(garages)) {
        garages.forEach(g => {
          const opt = document.createElement("option");
          opt.value = g.garage_id;
          opt.textContent = g.garage_name || `Garage #${g.garage_id}`;
          select.appendChild(opt);
        });
      }
    } catch (e) {
      console.error("Failed to load garages for review:", e);
    }
  }

  // Submit a review
  async function submitReview() {
    const garageId = document.getElementById("review_garage_id").value;
    const rating = parseInt(document.getElementById("selected_rating").value);
    const reviewText = document.getElementById("review_text").value.trim();
    const msgEl = document.getElementById("review_msg");

    if (!garageId) {
      showMessage(msgEl, "Please select a garage to review.", "error");
      return;
    }
    if (rating < 1 || rating > 5) {
      showMessage(msgEl, "Please select a rating between 1 and 5 stars.", "error");
      return;
    }
    if (!reviewText) {
      showMessage(msgEl, "Please write a review.", "error");
      return;
    }

    showMessage(msgEl, "Submitting review...", "success");

    try {
      const { res, data } = await apiPost("/reviews", {
        garage_id: garageId,
        rating: rating,
        review_text: reviewText
      });

      if (res.ok && data && data.success) {
        showMessage(msgEl, "Review submitted successfully!", "success");
        document.getElementById("review_garage_id").value = "";
        document.getElementById("selected_rating").value = "0";
        document.getElementById("review_text").value = "";
        updateStars(0);
        loadUserReviews();
      } else {
        showMessage(msgEl, data.error || "Failed to submit review.", "error");
      }
    } catch (e) {
      console.error("Submit review error:", e);
      showMessage(msgEl, "Network error. Please try again.", "error");
    }
  }

  // Load user's reviews
  async function loadUserReviews() {
    const container = document.getElementById("reviewsList");

    try {
      const { res, data } = await apiGet("/reviews");

      if (res.ok && data && data.reviews && data.reviews.length > 0) {
        container.innerHTML = "";
        data.reviews.forEach(review => {
          const reviewEl = createReviewElement(review);
          container.appendChild(reviewEl);
        });
      } else {
        container.innerHTML = '<div class="no-reviews">You haven\'t written any reviews yet. Share your experience!</div>';
      }
    } catch (e) {
      console.error("Failed to load reviews:", e);
      container.innerHTML = '<div class="no-reviews">Unable to load reviews.</div>';
    }
  }

  // Create review element
  function createReviewElement(review) {
    const div = document.createElement("div");
    div.className = "review-item";

    const stars = "‚òÖ".repeat(review.rating) + "‚òÜ".repeat(5 - review.rating);
    const date = new Date(review.created_at).toLocaleDateString("en-GB", {
      year: "numeric",
      month: "short",
      day: "numeric"
    });

    div.innerHTML = `
      <div class="review-header">
        <span class="review-garage-name">${review.garage_name || 'Garage #' + review.garage_id}</span>
        <span class="review-stars">${stars}</span>
      </div>
      <p class="review-text">${review.review_text}</p>
      <span class="review-date">Posted on ${date}</span>
    `;

    return div;
  }

  // Check if app.js loaded correctly
  document.addEventListener("DOMContentLoaded", function() {
    if (typeof reserve !== "function") {
      console.error("ERROR: reserve function not loaded!");
      const msgEl = document.getElementById("reserve_msg");
      if (msgEl) {
        showMessage(msgEl, "Error: JavaScript failed to load. Please refresh the page.", "error");
      }
    }
  });

  // =====================================================
  // ENHANCED EARNINGS DASHBOARD
  // =====================================================

  let earningsChart = null;
  let bookingsOffset = 0;
  const BOOKINGS_LIMIT = 10;

  // Load enhanced earnings data
  async function loadEnhancedEarnings() {
    try {
      // Load basic earnings
      const res = await fetch(API + "?route=my-earnings", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.earnings) {
        const earnings = data.earnings;
        if (earnings.total_earnings > 0 || earnings.total_spaces > 0) {
          // Show earnings dashboard
          document.getElementById("earningsDashboard").style.display = "block";
          document.getElementById("earningsCard").style.display = "block";
          document.getElementById("totalEarnings").textContent = parseFloat(earnings.total_earnings).toFixed(2);

          // Update dashboard summary cards
          document.getElementById("dashTotalEarnings").textContent = "¬£" + parseFloat(earnings.total_earnings).toFixed(2);
          document.getElementById("dashMonthEarnings").textContent = "¬£" + parseFloat(earnings.month_earnings || 0).toFixed(2);
          document.getElementById("dashPendingPayout").textContent = "¬£" + parseFloat(earnings.pending_payout || 0).toFixed(2);
          document.getElementById("dashTotalBookings").textContent = earnings.total_bookings || 0;

          // Load additional earnings data
          loadEarningsBySpace();
          loadEarningsByPeriod();
          loadOwnerBookings();
        }
      }
    } catch (e) {
      console.error("Failed to load enhanced earnings:", e);
    }
  }

  // Load earnings by space
  async function loadEarningsBySpace() {
    try {
      const res = await fetch(API + "?route=earnings/by-space", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.spaces) {
        const container = document.getElementById("earningsBySpaceList");

        if (data.spaces.length === 0) {
          container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No spaces listed yet.</p>';
          return;
        }

        container.innerHTML = data.spaces.map(space => {
          const statusColors = {
            active: { bg: '#f0fdf4', color: '#059669' },
            pending: { bg: '#fffbeb', color: '#d97706' },
            paused: { bg: '#f3f4f6', color: '#6b7280' }
          };
          const status = statusColors[space.status] || statusColors.pending;

          return `
            <div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <h4 style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">${space.space_name}</h4>
                <p style="font-size: 13px; color: #6b7280;">
                  ${space.city} ¬∑ ${space.total_bookings || 0} bookings ¬∑
                  <span style="color: ${status.color};">${space.status}</span>
                </p>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 18px; font-weight: 700; color: #059669;">¬£${parseFloat(space.total_earnings || 0).toFixed(2)}</div>
                <div style="font-size: 11px; color: #6b7280;">This month: ¬£${parseFloat(space.month_earnings || 0).toFixed(2)}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    } catch (e) {
      console.error("Failed to load earnings by space:", e);
    }
  }

  // Load earnings by period and render chart
  async function loadEarningsByPeriod() {
    const period = document.getElementById("earningsPeriod").value;

    try {
      const res = await fetch(API + `?route=earnings/by-period&period=${period}`, { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.data) {
        renderEarningsChart(data.data);
      }
    } catch (e) {
      console.error("Failed to load earnings by period:", e);
    }
  }

  // Render earnings chart
  function renderEarningsChart(periodData) {
    const ctx = document.getElementById("earningsChart");
    if (!ctx) return;

    // Destroy existing chart
    if (earningsChart) {
      earningsChart.destroy();
    }

    const labels = periodData.map(d => d.period_label);
    const earnings = periodData.map(d => parseFloat(d.earnings || 0));
    const bookings = periodData.map(d => parseInt(d.bookings || 0));

    earningsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Earnings (¬£)',
          data: earnings,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 1,
          borderRadius: 6,
          yAxisID: 'y'
        }, {
          label: 'Bookings',
          data: bookings,
          type: 'line',
          borderColor: 'rgba(37, 99, 235, 1)',
          backgroundColor: 'rgba(37, 99, 235, 0.1)',
          fill: true,
          tension: 0.4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: {
              callback: value => '¬£' + value
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          }
        }
      }
    });
  }

  // Load owner's bookings
  async function loadOwnerBookings(reset = true) {
    if (reset) {
      bookingsOffset = 0;
    }

    try {
      const res = await fetch(API + `?route=earnings/bookings&limit=${BOOKINGS_LIMIT}&offset=${bookingsOffset}`, { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.bookings) {
        const tbody = document.getElementById("recentBookingsTable");

        if (reset) {
          tbody.innerHTML = '';
        }

        if (data.bookings.length === 0 && reset) {
          tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6b7280;">No bookings yet.</td></tr>';
          document.getElementById("loadMoreBookings").style.display = "none";
          return;
        }

        data.bookings.forEach(booking => {
          const statusColors = {
            completed: { bg: '#f0fdf4', color: '#059669', text: 'Completed' },
            active: { bg: '#eff6ff', color: '#2563eb', text: 'Active' },
            confirmed: { bg: '#eff6ff', color: '#2563eb', text: 'Confirmed' },
            pending: { bg: '#fffbeb', color: '#d97706', text: 'Pending' },
            cancelled: { bg: '#fef2f2', color: '#dc2626', text: 'Cancelled' }
          };
          const status = statusColors[booking.booking_status] || statusColors.pending;
          const date = new Date(booking.start_time).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${booking.space_name}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${booking.renter_name}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${date}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
              <span style="background: ${status.bg}; color: ${status.color}; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                ${status.text}
              </span>
            </td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #059669;">
              ¬£${parseFloat(booking.owner_payout || 0).toFixed(2)}
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Show/hide load more button
        document.getElementById("loadMoreBookings").style.display = data.bookings.length >= BOOKINGS_LIMIT ? "inline-block" : "none";
        bookingsOffset += data.bookings.length;
      }
    } catch (e) {
      console.error("Failed to load owner bookings:", e);
    }
  }

  // Load more bookings
  function loadMoreBookings() {
    loadOwnerBookings(false);
  }

  // Export earnings to CSV
  async function exportEarnings() {
    try {
      const res = await fetch(API + "?route=earnings/bookings&limit=1000&offset=0", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.bookings) {
        const headers = ['Space', 'Renter', 'Start Time', 'End Time', 'Status', 'Total Price', 'Platform Fee', 'Your Earnings'];
        const rows = data.bookings.map(b => [
          b.space_name,
          b.renter_name,
          b.start_time,
          b.end_time,
          b.booking_status,
          b.total_price,
          b.platform_fee,
          b.owner_payout
        ]);

        let csv = headers.join(',') + '\n';
        rows.forEach(row => {
          csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `parkalot-earnings-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
    } catch (e) {
      console.error("Failed to export earnings:", e);
      alert("Failed to export earnings. Please try again.");
    }
  }

  // Start initialization
  initDashboard();
</script>

<!-- GSAP Animation Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<script>
  gsap.registerPlugin(ScrollTrigger);

  // Welcome Section Animation
  gsap.from('.welcome-section', {
    duration: 1,
    y: -30,
    opacity: 0,
    ease: 'power3.out'
  });

  gsap.from('.welcome-avatar', {
    duration: 0.8,
    scale: 0,
    ease: 'elastic.out(1, 0.5)',
    delay: 0.3
  });

  // Stat Cards Animation
  gsap.from('.stat-card', {
    duration: 0.6,
    y: 40,
    opacity: 0,
    stagger: 0.15,
    ease: 'power2.out',
    delay: 0.2
  });

  gsap.from('.stat-icon', {
    duration: 0.8,
    scale: 0,
    rotation: -15,
    ease: 'back.out(1.7)',
    stagger: 0.15,
    delay: 0.4
  });

  // Dashboard Cards Animation
  gsap.from('.dashboard-card', {
    scrollTrigger: {
      trigger: '.dashboard-grid',
      start: 'top 90%'
    },
    duration: 0.7,
    y: 50,
    opacity: 0,
    stagger: 0.12,
    ease: 'power2.out'
  });

  // Quick Actions Animation
  gsap.from('.quick-action-btn', {
    scrollTrigger: {
      trigger: '.quick-actions',
      start: 'top 90%'
    },
    duration: 0.5,
    y: 20,
    opacity: 0,
    stagger: 0.1,
    ease: 'power2.out'
  });
</script>

</body>
</html>
