<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Earnings - ParkaLot</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; color: #333; background: #f9fafb; min-height: 100vh; }

    .navbar { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
    .navbar-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .navbar-brand span { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; color: #2563eb; }
    .navbar-menu { display: flex; gap: 25px; list-style: none; align-items: center; }
    .navbar-menu a { color: #333; text-decoration: none; font-weight: 600; font-size: 15px; }
    .navbar-menu a:hover { color: #2563eb; }
    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; font-size: 15px; border: none; transition: all 0.3s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-outline { background: transparent; color: #2563eb; border: 2px solid #2563eb; }
    .btn-outline:hover { background: #2563eb; color: white; }

    .page-container { max-width: 1200px; margin: 0 auto; padding: 30px 5%; }

    /* Header Section */
    .page-header {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-content h1 { font-family: 'Poppins', sans-serif; font-size: 32px; margin-bottom: 10px; }
    .header-content p { font-size: 16px; opacity: 0.9; }
    .header-icon {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 15px;
    }
    .stat-icon.green { background: #f0fdf4; }
    .stat-icon.blue { background: #eff6ff; }
    .stat-icon.orange { background: #fff7ed; }
    .stat-icon.purple { background: #f3e8ff; }
    .stat-value {
      font-family: 'Poppins', sans-serif;
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }
    .stat-label { color: #6b7280; font-size: 14px; }
    .stat-change {
      font-size: 12px;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 20px;
      display: inline-block;
    }
    .stat-change.positive { background: #f0fdf4; color: #059669; }
    .stat-change.negative { background: #fef2f2; color: #dc2626; }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }
    .dashboard-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .dashboard-card.full-width { grid-column: span 2; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    .card-header h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-badge {
      background: #f0fdf4;
      color: #059669;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Space Earnings List */
    .space-earnings-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .space-earning-item {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    .space-earning-item:hover {
      background: #f3f4f6;
    }
    .space-info h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #1f2937;
    }
    .space-info p {
      font-size: 13px;
      color: #6b7280;
    }
    .space-earning-amount {
      text-align: right;
    }
    .space-earning-amount .amount {
      font-size: 18px;
      font-weight: 700;
      color: #059669;
    }
    .space-earning-amount .bookings {
      font-size: 12px;
      color: #6b7280;
    }

    /* Payments Table */
    .payments-table {
      width: 100%;
      border-collapse: collapse;
    }
    .payments-table th {
      text-align: left;
      padding: 12px;
      background: #f9fafb;
      font-weight: 600;
      font-size: 13px;
      color: #6b7280;
      border-bottom: 2px solid #e5e7eb;
    }
    .payments-table td {
      padding: 14px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    .payments-table tr:hover {
      background: #f9fafb;
    }
    .payment-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .payment-status.succeeded { background: #f0fdf4; color: #059669; }
    .payment-status.pending { background: #fffbeb; color: #d97706; }
    .payment-status.failed { background: #fef2f2; color: #dc2626; }
    .payment-status.refunded { background: #f3f4f6; color: #6b7280; }

    /* Payout Section */
    .payout-section {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .payout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .payout-header h3 {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .payout-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .payout-info-item {
      text-align: center;
    }
    .payout-info-item .value {
      font-size: 20px;
      font-weight: 700;
      color: #059669;
    }
    .payout-info-item .label {
      font-size: 12px;
      color: #6b7280;
    }

    /* Period Filter */
    .period-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .period-filter select {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    .empty-state h3 {
      font-size: 20px;
      color: #374151;
      margin-bottom: 8px;
    }
    .empty-state p {
      margin-bottom: 20px;
    }

    /* Loading */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .loading-spinner::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .pagination button:hover:not(:disabled) {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination .page-info {
      padding: 8px 16px;
      color: #6b7280;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .dashboard-grid { grid-template-columns: 1fr; }
      .dashboard-card.full-width { grid-column: span 1; }
      .payout-info { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .page-header { flex-direction: column; text-align: center; gap: 20px; }
      .stats-grid { grid-template-columns: 1fr; }
      .navbar-menu { display: none; }
      .payments-table { font-size: 12px; }
      .payments-table th, .payments-table td { padding: 10px 8px; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <a href="home.html" class="navbar-brand"><span>ParkaLot</span></a>
  <ul class="navbar-menu">
    <li><a href="find-parking.html">Find Parking</a></li>
    <li><a href="space-gallery.html">Space Gallery</a></li>
    <li><a href="customer_dashboard.html">Dashboard</a></li>
    <li><a href="customer-earning.html" style="color: #10b981;">My Earnings</a></li>
    <li><a href="profile.html">Profile</a></li>
    <li><a href="#" onclick="logout(); return false;">Logout</a></li>
  </ul>
</nav>

<div class="page-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1>My Earnings</h1>
      <p>Track your income from shared parking spaces in the Space Gallery</p>
    </div>
    <div class="header-icon">üí∞</div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon green">üíµ</div>
      <div class="stat-value" id="totalEarnings">¬£0.00</div>
      <div class="stat-label">Total Earnings</div>
      <div class="stat-change positive" id="earningsChange">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon blue">üìÖ</div>
      <div class="stat-value" id="monthEarnings">¬£0.00</div>
      <div class="stat-label">This Month</div>
      <div class="stat-change positive" id="monthChange">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon orange">‚è≥</div>
      <div class="stat-value" id="pendingPayout">¬£0.00</div>
      <div class="stat-label">Pending Payout</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">üé´</div>
      <div class="stat-value" id="totalBookings">0</div>
      <div class="stat-label">Total Bookings</div>
    </div>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Earnings Chart -->
    <div class="dashboard-card">
      <div class="card-header">
        <h2>üìä Earnings Overview</h2>
        <div class="period-filter">
          <select id="chartPeriod" onchange="loadEarningsByPeriod()">
            <option value="month">Monthly</option>
            <option value="week">Weekly</option>
            <option value="year">Yearly</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <!-- Earnings by Space -->
    <div class="dashboard-card">
      <div class="card-header">
        <h2>üÖøÔ∏è Earnings by Space</h2>
        <span class="card-badge" id="spaceCount">0 spaces</span>
      </div>
      <div class="space-earnings-list" id="spaceEarningsList">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <!-- Payout Section -->
  <div class="dashboard-card">
    <div class="card-header">
      <h2>üí≥ Payout Summary</h2>
      <button class="btn btn-success" onclick="setupPayout()" id="payoutBtn" style="padding: 8px 16px; font-size: 13px;">
        Set Up Payouts
      </button>
    </div>
    <div class="payout-section">
      <div class="payout-info">
        <div class="payout-info-item">
          <div class="value" id="availableBalance">¬£0.00</div>
          <div class="label">Available Balance</div>
        </div>
        <div class="payout-info-item">
          <div class="value" id="totalPaidOut">¬£0.00</div>
          <div class="label">Total Paid Out</div>
        </div>
        <div class="payout-info-item">
          <div class="value" id="nextPayoutDate">--</div>
          <div class="label">Next Payout</div>
        </div>
      </div>
    </div>
    <p style="font-size: 13px; color: #6b7280; margin-top: 12px;">
      <strong>Note:</strong> Payouts are processed automatically. A 10% platform fee is deducted from each booking.
      Payments from Space Gallery bookings are credited to your account within 2-3 business days.
    </p>
  </div>

  <!-- Recent Payments Table -->
  <div class="dashboard-card full-width">
    <div class="card-header">
      <h2>üí≥ Payment History</h2>
      <div class="period-filter">
        <select id="paymentFilter" onchange="loadPayments()">
          <option value="">All Payments</option>
          <option value="succeeded">Completed</option>
          <option value="pending">Pending</option>
          <option value="refunded">Refunded</option>
        </select>
        <button class="btn btn-outline" style="padding: 8px 16px; font-size: 13px;" onclick="exportPayments()">
          Export CSV
        </button>
      </div>
    </div>
    <div id="paymentsTableContainer">
      <table class="payments-table">
        <thead>
          <tr>
            <th>Space Name</th>
            <th>Renter</th>
            <th>Booking Date</th>
            <th>Duration</th>
            <th>Total Paid</th>
            <th>Platform Fee</th>
            <th>Your Earnings</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="paymentsTableBody">
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
              <div class="loading-spinner" style="display: inline-block;"></div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="pagination" id="paymentsPagination" style="display: none;">
        <button id="prevPage" onclick="changePage(-1)">Previous</button>
        <span class="page-info" id="pageInfo">Page 1</span>
        <button id="nextPage" onclick="changePage(1)">Next</button>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
    <a href="list-your-space.html" class="btn btn-success">+ List New Space</a>
    <a href="space-gallery.html" class="btn btn-outline">View Space Gallery</a>
    <a href="customer_dashboard.html" class="btn btn-outline">Back to Dashboard</a>
  </div>
</div>

<script>
  const API = "/api/index.php";
  let earningsChart = null;
  let currentPage = 1;
  const ITEMS_PER_PAGE = 10;
  let totalPayments = 0;

  // Initialize page
  async function init() {
    const isAuth = await checkAuth();
    if (isAuth) {
      loadEarningsSummary();
      loadEarningsBySpace();
      loadEarningsByPeriod();
      loadPayments();
      checkPayoutStatus();
    }
  }

  // Check authentication
  async function checkAuth() {
    try {
      const res = await fetch(API + "?route=me", { credentials: "same-origin" });
      if (!res.ok) {
        window.location.href = "index.html?redirect=customer-earning";
        return false;
      }
      return true;
    } catch (err) {
      console.error("Auth check failed:", err);
      window.location.href = "index.html?redirect=customer-earning";
      return false;
    }
  }

  // Load earnings summary
  async function loadEarningsSummary() {
    try {
      const res = await fetch(API + "?route=my-earnings", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.earnings) {
        const e = data.earnings;

        document.getElementById("totalEarnings").textContent = "¬£" + formatMoney(e.total_earnings || 0);
        document.getElementById("monthEarnings").textContent = "¬£" + formatMoney(e.month_earnings || 0);
        document.getElementById("pendingPayout").textContent = "¬£" + formatMoney(e.pending_payout || 0);
        document.getElementById("totalBookings").textContent = e.total_bookings || 0;

        // Show percentage changes if available
        if (e.earnings_change !== undefined) {
          const changeEl = document.getElementById("earningsChange");
          const change = parseFloat(e.earnings_change);
          changeEl.textContent = (change >= 0 ? "+" : "") + change.toFixed(1) + "% vs last month";
          changeEl.className = "stat-change " + (change >= 0 ? "positive" : "negative");
        }

        if (e.month_change !== undefined) {
          const monthChangeEl = document.getElementById("monthChange");
          const change = parseFloat(e.month_change);
          monthChangeEl.textContent = (change >= 0 ? "+" : "") + change.toFixed(1) + "% vs last month";
          monthChangeEl.className = "stat-change " + (change >= 0 ? "positive" : "negative");
        }
      }
    } catch (e) {
      console.error("Failed to load earnings summary:", e);
    }
  }

  // Load earnings by space
  async function loadEarningsBySpace() {
    const container = document.getElementById("spaceEarningsList");

    try {
      const res = await fetch(API + "?route=earnings/by-space", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.spaces) {
        const spaces = data.spaces;
        document.getElementById("spaceCount").textContent = spaces.length + " space" + (spaces.length !== 1 ? "s" : "");

        if (spaces.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üÖøÔ∏è</div>
              <h3>No Spaces Listed</h3>
              <p>List your parking space in the Gallery to start earning!</p>
              <a href="list-your-space.html" class="btn btn-success">List Your Space</a>
            </div>
          `;
          return;
        }

        container.innerHTML = spaces.map(space => `
          <div class="space-earning-item">
            <div class="space-info">
              <h4>${space.space_name}</h4>
              <p>${space.city} ¬∑ ${space.total_bookings || 0} bookings</p>
            </div>
            <div class="space-earning-amount">
              <div class="amount">¬£${formatMoney(space.total_earnings || 0)}</div>
              <div class="bookings">This month: ¬£${formatMoney(space.month_earnings || 0)}</div>
            </div>
          </div>
        `).join("");
      }
    } catch (e) {
      console.error("Failed to load earnings by space:", e);
      container.innerHTML = '<p style="text-align: center; color: #dc2626;">Failed to load data</p>';
    }
  }

  // Load earnings by period and render chart
  async function loadEarningsByPeriod() {
    const period = document.getElementById("chartPeriod").value;

    try {
      const res = await fetch(API + `?route=earnings/by-period&period=${period}`, { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.data) {
        renderChart(data.data);
      }
    } catch (e) {
      console.error("Failed to load earnings by period:", e);
    }
  }

  // Render earnings chart
  function renderChart(periodData) {
    const ctx = document.getElementById("earningsChart");
    if (!ctx) return;

    if (earningsChart) {
      earningsChart.destroy();
    }

    const labels = periodData.map(d => d.period_label);
    const earnings = periodData.map(d => parseFloat(d.earnings || 0));
    const bookings = periodData.map(d => parseInt(d.bookings || 0));

    earningsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Earnings (¬£)',
          data: earnings,
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 1,
          borderRadius: 6,
          yAxisID: 'y'
        }, {
          label: 'Bookings',
          data: bookings,
          type: 'line',
          borderColor: 'rgba(37, 99, 235, 1)',
          backgroundColor: 'rgba(37, 99, 235, 0.1)',
          fill: true,
          tension: 0.4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: {
              callback: value => '¬£' + value.toFixed(0)
            },
            grid: {
              color: 'rgba(0,0,0,0.05)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.dataset.label === 'Earnings (¬£)') {
                  return 'Earnings: ¬£' + context.parsed.y.toFixed(2);
                }
                return context.dataset.label + ': ' + context.parsed.y;
              }
            }
          }
        }
      }
    });
  }

  // Load payments/bookings history
  async function loadPayments() {
    const tbody = document.getElementById("paymentsTableBody");
    const filter = document.getElementById("paymentFilter").value;
    const offset = (currentPage - 1) * ITEMS_PER_PAGE;

    try {
      let url = `${API}?route=earnings/bookings&limit=${ITEMS_PER_PAGE}&offset=${offset}`;
      if (filter) {
        url += `&status=${filter}`;
      }

      const res = await fetch(url, { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.bookings) {
        const bookings = data.bookings;
        totalPayments = data.total || bookings.length;

        if (bookings.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8">
                <div class="empty-state">
                  <div class="empty-state-icon">üìã</div>
                  <h3>No Payments Yet</h3>
                  <p>When customers book your spaces from the Gallery, payments will appear here.</p>
                </div>
              </td>
            </tr>
          `;
          document.getElementById("paymentsPagination").style.display = "none";
          return;
        }

        tbody.innerHTML = bookings.map(b => {
          const statusClass = getStatusClass(b.payment_status || b.booking_status);
          const statusText = formatStatus(b.payment_status || b.booking_status);
          const bookingDate = formatDate(b.start_time);
          const duration = calculateDuration(b.start_time, b.end_time);
          const totalPaid = parseFloat(b.total_price || 0);
          const platformFee = parseFloat(b.platform_fee || totalPaid * 0.10);
          const ownerEarnings = parseFloat(b.owner_payout || (totalPaid - platformFee));

          return `
            <tr>
              <td><strong>${b.space_name || 'N/A'}</strong></td>
              <td>${b.renter_name || 'Customer'}</td>
              <td>${bookingDate}</td>
              <td>${duration}</td>
              <td>¬£${formatMoney(totalPaid)}</td>
              <td style="color: #dc2626;">-¬£${formatMoney(platformFee)}</td>
              <td style="color: #059669; font-weight: 600;">¬£${formatMoney(ownerEarnings)}</td>
              <td><span class="payment-status ${statusClass}">${statusText}</span></td>
            </tr>
          `;
        }).join("");

        // Update pagination
        const totalPages = Math.ceil(totalPayments / ITEMS_PER_PAGE);
        document.getElementById("paymentsPagination").style.display = totalPages > 1 ? "flex" : "none";
        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled = currentPage >= totalPages;
      }
    } catch (e) {
      console.error("Failed to load payments:", e);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Failed to load payments</td></tr>';
    }
  }

  // Change page
  function changePage(direction) {
    currentPage += direction;
    if (currentPage < 1) currentPage = 1;
    loadPayments();
  }

  // Check payout status
  async function checkPayoutStatus() {
    try {
      const res = await fetch(API + "?route=profile/stripe-status", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success) {
        const btn = document.getElementById("payoutBtn");

        if (data.stripe_status === "complete") {
          btn.textContent = "Payouts Active";
          btn.classList.remove("btn-success");
          btn.classList.add("btn-outline");
          btn.style.pointerEvents = "none";

          // Update payout info
          if (data.available_balance !== undefined) {
            document.getElementById("availableBalance").textContent = "¬£" + formatMoney(data.available_balance);
          }
          if (data.total_paid_out !== undefined) {
            document.getElementById("totalPaidOut").textContent = "¬£" + formatMoney(data.total_paid_out);
          }
          if (data.next_payout_date) {
            document.getElementById("nextPayoutDate").textContent = formatDate(data.next_payout_date);
          }
        } else if (data.stripe_status === "pending") {
          btn.textContent = "Complete Setup";
        }
      }
    } catch (e) {
      console.error("Failed to check payout status:", e);
    }
  }

  // Setup payout (Stripe Connect onboarding)
  async function setupPayout() {
    try {
      const res = await fetch(API + "?route=profile/stripe-onboard", {
        method: "POST",
        credentials: "same-origin"
      });
      const data = await res.json();

      if (data.success && data.onboarding_url) {
        window.location.href = data.onboarding_url;
      } else {
        alert(data.error || "Failed to start payout setup. Please try again.");
      }
    } catch (e) {
      alert("Network error. Please try again.");
    }
  }

  // Export payments to CSV
  async function exportPayments() {
    try {
      const res = await fetch(API + "?route=earnings/bookings&limit=1000&offset=0", { credentials: "same-origin" });
      const data = await res.json();

      if (data.success && data.bookings) {
        const headers = ['Space Name', 'Renter', 'Start Time', 'End Time', 'Total Price', 'Platform Fee', 'Your Earnings', 'Status'];
        const rows = data.bookings.map(b => {
          const totalPaid = parseFloat(b.total_price || 0);
          const platformFee = parseFloat(b.platform_fee || totalPaid * 0.10);
          const ownerEarnings = parseFloat(b.owner_payout || (totalPaid - platformFee));
          return [
            b.space_name || '',
            b.renter_name || '',
            b.start_time || '',
            b.end_time || '',
            totalPaid.toFixed(2),
            platformFee.toFixed(2),
            ownerEarnings.toFixed(2),
            b.payment_status || b.booking_status || ''
          ];
        });

        let csv = headers.join(',') + '\n';
        rows.forEach(row => {
          csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `parkalot-earnings-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
    } catch (e) {
      console.error("Failed to export:", e);
      alert("Failed to export earnings. Please try again.");
    }
  }

  // Helper functions
  function formatMoney(amount) {
    return parseFloat(amount || 0).toFixed(2);
  }

  function formatDate(dateStr) {
    if (!dateStr) return '--';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', {
      day: 'numeric',
      month: 'short',
      year: 'numeric'
    });
  }

  function calculateDuration(start, end) {
    if (!start || !end) return '--';
    const startDate = new Date(start);
    const endDate = new Date(end);
    const hours = Math.round((endDate - startDate) / (1000 * 60 * 60));
    if (hours < 24) {
      return hours + ' hour' + (hours !== 1 ? 's' : '');
    }
    const days = Math.round(hours / 24);
    return days + ' day' + (days !== 1 ? 's' : '');
  }

  function getStatusClass(status) {
    const statusMap = {
      'succeeded': 'succeeded',
      'completed': 'succeeded',
      'paid': 'succeeded',
      'pending': 'pending',
      'confirmed': 'pending',
      'failed': 'failed',
      'cancelled': 'failed',
      'refunded': 'refunded'
    };
    return statusMap[status] || 'pending';
  }

  function formatStatus(status) {
    const statusMap = {
      'succeeded': 'Paid',
      'completed': 'Completed',
      'paid': 'Paid',
      'pending': 'Pending',
      'confirmed': 'Confirmed',
      'failed': 'Failed',
      'cancelled': 'Cancelled',
      'refunded': 'Refunded'
    };
    return statusMap[status] || status || 'Unknown';
  }

  // Logout function
  function logout() {
    fetch(API + "?route=logout", { credentials: "same-origin" })
      .then(() => {
        window.location.href = "index.html";
      })
      .catch(() => {
        window.location.href = "index.html";
      });
  }

  // Initialize
  init();
</script>

</body>
</html>
