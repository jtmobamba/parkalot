<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parking Space Gallery - ParkaLot</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; color: #333; background: #f9fafb; min-height: 100vh; }

    .navbar { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
    .navbar-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
    .navbar-brand span { font-family: 'Poppins', sans-serif; font-size: 24px; font-weight: 700; color: #2563eb; }
    .navbar-menu { display: flex; gap: 25px; list-style: none; align-items: center; }
    .navbar-menu a { color: #333; text-decoration: none; font-weight: 600; font-size: 15px; }
    .navbar-menu a:hover { color: #2563eb; }
    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; font-size: 15px; border: none; transition: all 0.3s; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }

    .hero-section {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 60px 5%;
      text-align: center;
    }
    .hero-section h1 { font-family: 'Poppins', sans-serif; font-size: 42px; margin-bottom: 16px; }
    .hero-section p { font-size: 18px; opacity: 0.9; max-width: 600px; margin: 0 auto 24px; }

    .filters-section {
      background: white;
      padding: 20px 5%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-group label { font-weight: 600; font-size: 14px; color: #6b7280; }
    .filter-group select, .filter-group input {
      padding: 10px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      min-width: 150px;
    }

    .gallery-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 5%;
    }

    .gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .gallery-header h2 { font-family: 'Poppins', sans-serif; font-size: 24px; }
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #10b981;
    }
    .live-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .gallery-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .gallery-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    .gallery-card.new {
      animation: fadeInUp 0.5s ease-out;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f3f4f6;
    }
    .card-image-placeholder {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #9ca3af;
    }

    .card-content { padding: 20px; }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #1f2937; }
    .card-location { font-size: 14px; color: #6b7280; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
    .card-meta { display: flex; justify-content: space-between; align-items: center; }
    .card-price { font-size: 20px; font-weight: 700; color: #2563eb; }
    .card-price span { font-size: 14px; font-weight: 400; color: #6b7280; }
    .card-rating { display: flex; align-items: center; gap: 4px; font-size: 14px; color: #f59e0b; }

    .amenities-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }
    .amenity-tag {
      background: #f3f4f6;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      color: #6b7280;
    }

    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .card-actions .btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 14px;
      text-align: center;
    }

    .load-more {
      display: block;
      margin: 40px auto;
      padding: 16px 48px;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .no-results h3 { font-size: 24px; margin-bottom: 12px; color: #374151; }

    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    .loading-spinner::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Booking Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover { color: #374151; }
    .modal-body {
      padding: 24px;
    }

    .space-preview {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .space-preview-image {
      width: 100px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
    }
    .space-preview-info h3 {
      font-size: 16px;
      margin: 0 0 4px 0;
    }
    .space-preview-info p {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    .space-preview-price {
      font-size: 18px;
      font-weight: 700;
      color: #2563eb;
      margin-top: 4px;
    }

    .booking-form-group {
      margin-bottom: 16px;
    }
    .booking-form-group label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      color: #374151;
    }
    .booking-form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    .booking-form-group input:focus {
      outline: none;
      border-color: #2563eb;
    }
    .booking-form-row {
      display: flex;
      gap: 12px;
    }
    .booking-form-row .booking-form-group {
      flex: 1;
    }

    .booking-summary {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
    }
    .booking-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }
    .booking-summary-row.total {
      border-top: 1px solid #e5e7eb;
      margin-top: 8px;
      padding-top: 12px;
      font-weight: 700;
      font-size: 16px;
    }

    #payment-container {
      min-height: 100px;
    }

    .payment-success {
      text-align: center;
      padding: 30px 20px;
    }
    .payment-success-icon {
      width: 70px;
      height: 70px;
      background: #dcfce7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }
    .payment-success-icon svg {
      width: 36px;
      height: 36px;
      color: #16a34a;
    }
    .payment-success h3 {
      font-size: 20px;
      margin: 0 0 8px 0;
    }
    .payment-success p {
      color: #6b7280;
      margin: 0 0 20px 0;
    }

    @media (max-width: 768px) {
      .hero-section h1 { font-size: 28px; }
      .gallery-grid { grid-template-columns: 1fr; }
      .filters-section { flex-direction: column; }
      .space-preview { flex-direction: column; }
      .space-preview-image { width: 100%; height: 150px; }
    }
  </style>
</head>
<body>

<nav class="navbar">
  <a href="home.html" class="navbar-brand">
    <span>ParkaLot</span>
  </a>
  <ul class="navbar-menu">
    <li><a href="find-parking.html">Find Parking</a></li>
    <li><a href="space-gallery.html" style="color: #2563eb;">Gallery</a></li>
    <li><a href="list-your-space.html">List Your Space</a></li>
    <li><a href="customer_dashboard.html" class="btn btn-primary">Dashboard</a></li>
  </ul>
</nav>

<section class="hero-section">
  <h1>Explore Parking Spaces</h1>
  <p>Browse photos of available garages, driveways, and parking spots shared by our community</p>
  <a href="list-your-space.html" class="btn btn-success">Share Your Space & Earn</a>
</section>

<section class="filters-section">
  <div class="filter-group">
    <label>Type:</label>
    <select id="filterType" onchange="applyFilters()">
      <option value="">All Types</option>
      <option value="garage">Garage</option>
      <option value="driveway">Driveway</option>
      <option value="parking_spot">Parking Spot</option>
      <option value="car_park">Car Park</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Location:</label>
    <input type="text" id="filterLocation" placeholder="City or postcode" onkeyup="debounceFilter()">
  </div>
  <div class="filter-group">
    <label>Sort:</label>
    <select id="filterSort" onchange="applyFilters()">
      <option value="newest">Newest First</option>
      <option value="price_low">Price: Low to High</option>
      <option value="price_high">Price: High to Low</option>
      <option value="rating">Highest Rated</option>
    </select>
  </div>
</section>

<div class="gallery-container">
  <div class="gallery-header">
    <h2>Recently Added Spaces</h2>
    <div class="live-indicator">
      <span class="live-dot"></span>
      <span>Live Updates</span>
    </div>
  </div>

  <div id="galleryGrid" class="gallery-grid">
    <div class="loading-spinner"></div>
  </div>

  <button id="loadMoreBtn" class="btn btn-primary load-more" style="display: none;" onclick="loadMore()">
    Load More Spaces
  </button>
</div>

<!-- Booking Modal -->
<div class="modal-overlay" id="bookingModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Book Parking Space</h2>
      <button class="modal-close" onclick="closeBookingModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="space-preview" id="spacePreview">
        <!-- Populated dynamically -->
      </div>

      <div id="bookingForm">
        <div class="booking-form-row">
          <div class="booking-form-group">
            <label>Start Date & Time</label>
            <input type="datetime-local" id="startDateTime">
          </div>
          <div class="booking-form-group">
            <label>End Date & Time</label>
            <input type="datetime-local" id="endDateTime">
          </div>
        </div>

        <div class="booking-summary" id="bookingSummary" style="display: none;">
          <!-- Populated dynamically -->
        </div>

        <button class="btn btn-primary" style="width: 100%;" id="proceedToPaymentBtn" onclick="proceedToPayment()">
          Proceed to Payment
        </button>
      </div>

      <div id="payment-container" style="display: none;">
        <!-- Stripe payment component mounts here -->
      </div>
    </div>
  </div>
</div>

<!-- Stripe Payment Component -->
<script src="js/components/stripe-payment.js"></script>

<script>
  const API = "/api/index.php";
  let allSpaces = [];
  let displayedSpaces = [];
  let offset = 0;
  const LIMIT = 12;
  let lastTimestamp = null;
  let pollingInterval = null;
  let filterTimeout = null;
  let selectedSpace = null;
  let currentBooking = null;
  let stripePayment = null;

  // Amenity display names
  const amenityNames = {
    covered: 'Covered',
    cctv: 'CCTV',
    ev_charging: 'EV Charging',
    '24_7_access': '24/7 Access',
    disabled_access: 'Accessible',
    security_lighting: 'Lit'
  };

  // Load gallery spaces
  async function loadGallery(reset = true) {
    const grid = document.getElementById('galleryGrid');

    if (reset) {
      offset = 0;
      allSpaces = [];
      grid.innerHTML = '<div class="loading-spinner"></div>';
    }

    try {
      const res = await fetch(`${API}?route=spaces/gallery&limit=${LIMIT}&offset=${offset}`);
      const data = await res.json();

      if (data.success && data.spaces) {
        if (reset && data.spaces.length === 0) {
          grid.innerHTML = `
            <div class="no-results" style="grid-column: 1/-1;">
              <h3>No spaces available yet</h3>
              <p>Be the first to share your parking space!</p>
              <a href="list-your-space.html" class="btn btn-success" style="margin-top: 20px;">List Your Space</a>
            </div>
          `;
          document.getElementById('loadMoreBtn').style.display = 'none';
          return;
        }

        allSpaces = reset ? data.spaces : [...allSpaces, ...data.spaces];
        lastTimestamp = data.timestamp;

        applyFilters();

        document.getElementById('loadMoreBtn').style.display =
          data.spaces.length >= LIMIT ? 'block' : 'none';

        offset += data.spaces.length;

        // Start polling for updates
        startPolling();
      }
    } catch (e) {
      console.error('Failed to load gallery:', e);
      grid.innerHTML = `
        <div class="no-results" style="grid-column: 1/-1;">
          <h3>Unable to load spaces</h3>
          <p>Please try again later.</p>
        </div>
      `;
    }
  }

  // Apply filters and sort
  function applyFilters() {
    const type = document.getElementById('filterType').value;
    const location = document.getElementById('filterLocation').value.toLowerCase();
    const sort = document.getElementById('filterSort').value;

    let filtered = [...allSpaces];

    // Filter by type
    if (type) {
      filtered = filtered.filter(s => s.space_type === type);
    }

    // Filter by location
    if (location) {
      filtered = filtered.filter(s =>
        (s.city && s.city.toLowerCase().includes(location)) ||
        (s.postcode && s.postcode.toLowerCase().includes(location))
      );
    }

    // Sort
    switch (sort) {
      case 'price_low':
        filtered.sort((a, b) => parseFloat(a.price_per_hour) - parseFloat(b.price_per_hour));
        break;
      case 'price_high':
        filtered.sort((a, b) => parseFloat(b.price_per_hour) - parseFloat(a.price_per_hour));
        break;
      case 'rating':
        filtered.sort((a, b) => (parseFloat(b.average_rating) || 0) - (parseFloat(a.average_rating) || 0));
        break;
      default:
        // Newest first (default)
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }

    displayedSpaces = filtered;
    renderGallery();
  }

  // Debounce filter input
  function debounceFilter() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(applyFilters, 300);
  }

  // Render gallery grid
  function renderGallery(newSpaces = null) {
    const grid = document.getElementById('galleryGrid');

    if (newSpaces) {
      // Prepend new spaces with animation
      newSpaces.forEach(space => {
        const card = createSpaceCard(space, true);
        grid.insertBefore(card, grid.firstChild);
      });
    } else {
      // Full render
      if (displayedSpaces.length === 0) {
        grid.innerHTML = `
          <div class="no-results" style="grid-column: 1/-1;">
            <h3>No matching spaces found</h3>
            <p>Try adjusting your filters.</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = '';
      displayedSpaces.forEach(space => {
        grid.appendChild(createSpaceCard(space));
      });
    }
  }

  // Create space card element
  function createSpaceCard(space, isNew = false) {
    const card = document.createElement('div');
    card.className = 'gallery-card' + (isNew ? ' new' : '');

    const photo = space.photos && space.photos.length > 0 ? space.photos[0] : null;
    const rating = parseFloat(space.average_rating) || 0;
    const stars = rating > 0 ? '‚òÖ'.repeat(Math.round(rating)) + '‚òÜ'.repeat(5 - Math.round(rating)) : 'No reviews';

    const amenities = space.amenities || [];

    card.innerHTML = `
      ${photo ?
        `<img class="card-image" src="${photo}" alt="${space.space_name}" onerror="this.outerHTML='<div class=\\'card-image-placeholder\\'>üÖøÔ∏è</div>'">` :
        '<div class="card-image-placeholder">üÖøÔ∏è</div>'
      }
      <div class="card-content">
        <h3 class="card-title">${space.space_name}</h3>
        <div class="card-location">üìç ${space.city}${space.postcode ? ', ' + space.postcode : ''}</div>
        <div class="card-meta">
          <div class="card-price">¬£${parseFloat(space.price_per_hour).toFixed(2)} <span>/hour</span></div>
          <div class="card-rating">${stars}</div>
        </div>
        ${amenities.length > 0 ? `
          <div class="amenities-tags">
            ${amenities.slice(0, 4).map(a => `<span class="amenity-tag">${amenityNames[a] || a}</span>`).join('')}
          </div>
        ` : ''}
        <div class="card-actions">
          <button class="btn btn-primary" onclick="event.stopPropagation(); openBookingModal(${space.space_id})">Purchase Parking</button>
        </div>
      </div>
    `;

    return card;
  }

  // Open booking modal
  async function openBookingModal(spaceId) {
    // Check authentication
    try {
      const authRes = await fetch(API + '?route=me', { credentials: 'same-origin' });
      if (!authRes.ok) {
        window.location.href = `index.html?redirect=space-gallery&space=${spaceId}`;
        return;
      }
    } catch (e) {
      window.location.href = `index.html?redirect=space-gallery&space=${spaceId}`;
      return;
    }

    // Find the space
    selectedSpace = allSpaces.find(s => s.space_id === spaceId);
    if (!selectedSpace) {
      alert('Space not found');
      return;
    }

    // Populate space preview
    const preview = document.getElementById('spacePreview');
    const photo = selectedSpace.photos && selectedSpace.photos.length > 0 ? selectedSpace.photos[0] : null;
    preview.innerHTML = `
      ${photo ?
        `<img class="space-preview-image" src="${photo}" alt="${selectedSpace.space_name}">` :
        '<div class="space-preview-image" style="display:flex;align-items:center;justify-content:center;font-size:32px;">üÖøÔ∏è</div>'
      }
      <div class="space-preview-info">
        <h3>${selectedSpace.space_name}</h3>
        <p>üìç ${selectedSpace.city}${selectedSpace.postcode ? ', ' + selectedSpace.postcode : ''}</p>
        <div class="space-preview-price">¬£${parseFloat(selectedSpace.price_per_hour).toFixed(2)}/hour</div>
      </div>
    `;

    // Set default dates (now + 1 hour)
    const now = new Date();
    const startDate = new Date(now.getTime() + 60 * 60 * 1000);
    const endDate = new Date(startDate.getTime() + 2 * 60 * 60 * 1000);

    document.getElementById('startDateTime').value = formatDateTimeLocal(startDate);
    document.getElementById('endDateTime').value = formatDateTimeLocal(endDate);

    // Reset form state
    document.getElementById('bookingForm').style.display = 'block';
    document.getElementById('payment-container').style.display = 'none';
    document.getElementById('bookingSummary').style.display = 'none';

    // Open modal
    document.getElementById('bookingModal').classList.add('active');
    document.body.style.overflow = 'hidden';

    // Update summary on date change
    document.getElementById('startDateTime').onchange = updateBookingSummary;
    document.getElementById('endDateTime').onchange = updateBookingSummary;

    updateBookingSummary();
  }

  // Format date for datetime-local input
  function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // Update booking summary
  function updateBookingSummary() {
    const startInput = document.getElementById('startDateTime').value;
    const endInput = document.getElementById('endDateTime').value;

    if (!startInput || !endInput || !selectedSpace) {
      document.getElementById('bookingSummary').style.display = 'none';
      return;
    }

    const startTime = new Date(startInput);
    const endTime = new Date(endInput);

    if (endTime <= startTime) {
      document.getElementById('bookingSummary').style.display = 'none';
      return;
    }

    const hours = Math.ceil((endTime - startTime) / (1000 * 60 * 60));
    const hourlyRate = parseFloat(selectedSpace.price_per_hour);
    const subtotal = hours * hourlyRate;
    const serviceFee = subtotal * 0.10;
    const total = subtotal + serviceFee;

    currentBooking = {
      spaceId: selectedSpace.space_id,
      spaceName: selectedSpace.space_name,
      location: `${selectedSpace.city}${selectedSpace.postcode ? ', ' + selectedSpace.postcode : ''}`,
      startTime: startTime,
      endTime: endTime,
      hours: hours,
      hourlyRate: hourlyRate,
      subtotal: subtotal,
      serviceFee: serviceFee,
      total: total
    };

    const summary = document.getElementById('bookingSummary');
    summary.style.display = 'block';
    summary.innerHTML = `
      <div class="booking-summary-row">
        <span>Duration</span>
        <span>${hours} hour${hours > 1 ? 's' : ''}</span>
      </div>
      <div class="booking-summary-row">
        <span>Parking (${hours}h √ó ¬£${hourlyRate.toFixed(2)})</span>
        <span>¬£${subtotal.toFixed(2)}</span>
      </div>
      <div class="booking-summary-row">
        <span>Service Fee (10%)</span>
        <span>¬£${serviceFee.toFixed(2)}</span>
      </div>
      <div class="booking-summary-row total">
        <span>Total</span>
        <span>¬£${total.toFixed(2)}</span>
      </div>
    `;
  }

  // Proceed to payment
  async function proceedToPayment() {
    if (!currentBooking) {
      alert('Please select valid booking times');
      return;
    }

    // Hide booking form, show payment
    document.getElementById('bookingForm').style.display = 'none';
    document.getElementById('payment-container').style.display = 'block';

    // Initialize Stripe payment
    if (stripePayment) {
      stripePayment.destroy();
    }

    stripePayment = new StripePayment('payment-container', {
      apiEndpoint: API,
      onSuccess: handlePaymentSuccess,
      onError: handlePaymentError,
      onCancel: handlePaymentCancel
    });

    await stripePayment.init();

    stripePayment.render({
      spaceName: currentBooking.spaceName,
      location: currentBooking.location,
      duration: `${currentBooking.hours} hour${currentBooking.hours > 1 ? 's' : ''}`,
      dates: `${formatDateTime(currentBooking.startTime)} - ${formatDateTime(currentBooking.endTime)}`,
      subtotal: currentBooking.subtotal,
      serviceFee: currentBooking.serviceFee,
      amount: currentBooking.total,
      bookingType: 'customer_space',
      spaceId: currentBooking.spaceId
    });
  }

  // Format date time for display
  function formatDateTime(date) {
    return date.toLocaleDateString('en-GB', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Handle successful payment
  function handlePaymentSuccess(result) {
    document.getElementById('payment-container').innerHTML = `
      <div class="payment-success">
        <div class="payment-success-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
        </div>
        <h3>Booking Confirmed!</h3>
        <p>Your parking space has been reserved. Check your email for confirmation details.</p>
        <p style="font-size: 12px; color: #9ca3af; margin-bottom: 20px;">
          Reference: ${result.paymentIntentId || 'DEMO-' + Date.now()}
        </p>
        <button class="btn btn-primary" onclick="goToDashboard()">View My Bookings</button>
        <button class="btn btn-secondary" style="margin-top: 10px;" onclick="closeBookingModal()">Continue Browsing</button>
      </div>
    `;

    // Create booking in backend
    createSpaceBooking(result);
  }

  // Create space booking after payment
  async function createSpaceBooking(paymentResult) {
    try {
      const response = await fetch(API + '?route=spaces/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          space_id: currentBooking.spaceId,
          start_time: currentBooking.startTime.toISOString(),
          end_time: currentBooking.endTime.toISOString(),
          payment_intent_id: paymentResult.paymentIntentId,
          total_price: currentBooking.total
        })
      });

      const data = await response.json();
      if (!data.success) {
        console.warn('Booking creation returned:', data);
      }
    } catch (e) {
      console.error('Failed to create booking:', e);
    }
  }

  // Handle payment error
  function handlePaymentError(error) {
    console.error('Payment failed:', error);
  }

  // Handle payment cancel
  function handlePaymentCancel() {
    document.getElementById('bookingForm').style.display = 'block';
    document.getElementById('payment-container').style.display = 'none';

    if (stripePayment) {
      stripePayment.destroy();
      stripePayment = null;
    }
    document.getElementById('payment-container').innerHTML = '';
  }

  // Close booking modal
  function closeBookingModal() {
    document.getElementById('bookingModal').classList.remove('active');
    document.body.style.overflow = '';

    if (stripePayment) {
      stripePayment.destroy();
      stripePayment = null;
    }
    document.getElementById('payment-container').innerHTML = '';
    selectedSpace = null;
    currentBooking = null;
  }

  // Go to dashboard
  function goToDashboard() {
    window.location.href = 'customer_dashboard.html';
  }

  // Load more spaces
  function loadMore() {
    loadGallery(false);
  }

  // Poll for new spaces
  function startPolling() {
    if (pollingInterval) {
      clearInterval(pollingInterval);
    }

    pollingInterval = setInterval(async () => {
      if (!lastTimestamp) return;

      try {
        const res = await fetch(`${API}?route=spaces/gallery&limit=10&offset=0&since=${encodeURIComponent(lastTimestamp)}`);
        const data = await res.json();

        if (data.success && data.spaces && data.spaces.length > 0) {
          const newSpaces = data.spaces.filter(
            ns => !allSpaces.some(s => s.space_id === ns.space_id)
          );

          if (newSpaces.length > 0) {
            allSpaces = [...newSpaces, ...allSpaces];
            lastTimestamp = data.timestamp;
            applyFilters();
            renderGallery(newSpaces);
          }
        }
      } catch (e) {
        console.error('Polling error:', e);
      }
    }, 30000);
  }

  // Stop polling when page is hidden
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (pollingInterval) clearInterval(pollingInterval);
    } else {
      startPolling();
    }
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeBookingModal();
  });

  // Close modal on backdrop click
  document.getElementById('bookingModal').addEventListener('click', (e) => {
    if (e.target.id === 'bookingModal') closeBookingModal();
  });

  // Initialize
  loadGallery();
</script>

</body>
</html>
