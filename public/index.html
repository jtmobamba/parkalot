<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ParkaLot System</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">

  <h1>ParkaLot System</h1>

  <form class="card" id="loginForm">
    <h2>Login</h2>

    <label>Email</label>
    <input id="login_email" type="email" placeholder="Email">

    <label>Password</label>
    <input id="login_password" type="password" placeholder="Password">
    <div id="loginMessage" class="form-message" style="
  margin-top: 10px;
  margin-bottom: 10px;
  padding: 12px;
  font-size: 14px;
  text-align: center;
  border-radius: 5px;
  min-height: 20px;
  color: #c0392b;
  background-color: #fadbd8;
  border: 1px solid #e74c3c;
  font-weight: 500;"></div>
    <button class="btn primary" type="submit">Login</button>
    <p style="margin-top: 15px; text-align: center;">
      <a href="#" onclick="showForgotPasswordModal()" style="color: #3498db; text-decoration: none; font-size: 14px;">Forgot Password?</a>
    </p>
  </form>

  <!-- Quick Action Buttons -->
  <div style="text-align: center; margin: 25px 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
    <button onclick="showForgotPasswordModal()" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
      Reset Password
    </button>
    <button onclick="showLicensePlateModal()" class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
      Verify License Plate
    </button>
    <a href="login_vehicle_inspector.html" class="btn" style="background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; display: inline-block; font-weight: 600;">
      Vehicle Inspector Login
    </a>
  </div>

  <form class="card" id="registerForm">
    <h2>Register</h2>

    <label>Full Name</label>
    <input id="reg_name" placeholder="Full Name">

    <label>Email</label>
    <input id="reg_email" type="email" placeholder="Email">

    <label>Password</label>
    <input id="reg_password" type="password" placeholder="Password">
    <div id="registerMessage" class="form-message" style="
  margin-top: 10px;
  margin-bottom: 10px;
  padding: 12px;
  font-size: 14px;
  text-align: center;
  border-radius: 5px;
  min-height: 20px;
  color: #c0392b;
  background-color: #fadbd8;
  border: 1px solid #e74c3c;
  font-weight: 500;"></div>
    <button class="btn primary" type="submit">Register</button>
  </form>

</div>

<!-- Email Verification Modal -->
<div id="verificationModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    border-radius: 10px;
    padding: 30px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  ">
    <h2 style="margin-top: 0; color: #3498db; text-align: center;">ðŸ“§ Email Verification</h2>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
      We've sent a 6-digit verification code to your email address.
    </p>
    
    <div id="verificationMessage" style="
      margin: 15px 0;
      padding: 12px;
      border-radius: 5px;
      text-align: center;
      display: none;
    "></div>
    
    <div style="margin: 20px 0;">
      <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
        Enter Verification Code:
      </label>
      <input 
        id="otpInput" 
        type="text" 
        placeholder="000000" 
        maxlength="6"
        style="
          width: 100%;
          padding: 15px;
          font-size: 24px;
          text-align: center;
          letter-spacing: 10px;
          border: 2px solid #ddd;
          border-radius: 5px;
          box-sizing: border-box;
          font-weight: bold;
        "
      >
      <p style="font-size: 12px; color: #999; margin-top: 5px; text-align: center;">
        Code expires in 10 minutes
      </p>
    </div>
    
    <button 
      id="verifyButton" 
      style="
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
      "
    >
      Verify Email
    </button>
    
    <button 
      id="resendOtpButton" 
      style="
        width: 100%;
        padding: 10px;
        background: white;
        color: #3498db;
        border: 2px solid #3498db;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 10px;
      "
    >
      Resend Code
    </button>
    
    <p style="text-align: center; font-size: 13px; color: #999; margin-top: 15px;">
      Didn't receive the code? Check your spam folder or click resend.
    </p>
  </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    border-radius: 10px;
    padding: 30px;
    max-width: 450px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  ">
    <h2 style="margin-top: 0; color: #e74c3c; text-align: center;">Reset Password</h2>

    <!-- Step 1: Enter Email -->
    <div id="forgotStep1">
      <p style="text-align: center; color: #666; margin-bottom: 20px;">
        Enter your email address and we'll send you a verification code.
      </p>

      <div id="forgotMessage" style="
        margin: 15px 0;
        padding: 12px;
        border-radius: 5px;
        text-align: center;
        display: none;
      "></div>

      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
          Email Address:
        </label>
        <input
          id="forgotEmail"
          type="email"
          placeholder="your@email.com"
          style="
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
          "
        >
      </div>

      <button
        onclick="sendResetCode()"
        style="
          width: 100%;
          padding: 12px;
          background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
          color: white;
          border: none;
          border-radius: 5px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-bottom: 10px;
        "
      >
        Send Reset Code
      </button>
    </div>

    <!-- Step 2: Enter OTP and New Password -->
    <div id="forgotStep2" style="display: none;">
      <p style="text-align: center; color: #666; margin-bottom: 20px;">
        Enter the verification code sent to your email and your new password.
      </p>

      <div id="resetMessage" style="
        margin: 15px 0;
        padding: 12px;
        border-radius: 5px;
        text-align: center;
        display: none;
      "></div>

      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
          Verification Code:
        </label>
        <input
          id="resetOtpInput"
          type="text"
          placeholder="000000"
          maxlength="6"
          style="
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-weight: bold;
          "
        >
      </div>

      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
          New Password:
        </label>
        <input
          id="newPassword"
          type="password"
          placeholder="Enter new password (min 8 chars)"
          style="
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
          "
        >
      </div>

      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
          Confirm Password:
        </label>
        <input
          id="confirmPassword"
          type="password"
          placeholder="Confirm new password"
          style="
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
          "
        >
      </div>

      <button
        onclick="resetPassword()"
        style="
          width: 100%;
          padding: 12px;
          background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
          color: white;
          border: none;
          border-radius: 5px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-bottom: 10px;
        "
      >
        Reset Password
      </button>

      <button
        onclick="resendResetCode()"
        style="
          width: 100%;
          padding: 10px;
          background: white;
          color: #3498db;
          border: 2px solid #3498db;
          border-radius: 5px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
        "
      >
        Resend Code
      </button>
    </div>

    <p style="text-align: center; margin-top: 15px;">
      <a href="#" onclick="hideForgotPasswordModal()" style="color: #999; text-decoration: none; font-size: 14px;">Cancel</a>
    </p>
  </div>
</div>

<!-- License Plate Verification Modal -->
<div id="licensePlateModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  overflow-y: auto;
  padding: 20px;
  box-sizing: border-box;
">
  <div style="
    background: white;
    border-radius: 10px;
    padding: 30px;
    max-width: 600px;
    width: 100%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-height: 90vh;
    overflow-y: auto;
  ">
    <h2 style="margin-top: 0; color: #27ae60; text-align: center;">Verify License Plate</h2>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
      Enter a UK license plate to check vehicle details from the DVLA database.
    </p>

    <div id="plateMessage" style="
      margin: 15px 0;
      padding: 12px;
      border-radius: 5px;
      text-align: center;
      display: none;
    "></div>

    <div style="margin: 20px 0;">
      <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
        License Plate Number:
      </label>
      <div style="display: flex; gap: 10px;">
        <input
          id="plateInput"
          type="text"
          placeholder="e.g., AB12 CDE"
          maxlength="10"
          style="
            flex: 1;
            padding: 15px;
            font-size: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-weight: bold;
          "
        >
        <button
          onclick="verifyLicensePlate()"
          style="
            padding: 15px 25px;
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
          "
        >
          Check
        </button>
      </div>
    </div>

    <!-- Vehicle Results -->
    <div id="vehicleResults" style="display: none; margin-top: 20px;">
      <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div id="resultPlate" style="
            background: #f1c40f;
            color: #1a1a2e;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            font-family: monospace;
          ">AB12 CDE</div>
          <div id="resultBadges"></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">Vehicle Info</h4>
            <p><strong>Make:</strong> <span id="resMake">-</span></p>
            <p><strong>Model:</strong> <span id="resModel">-</span></p>
            <p><strong>Colour:</strong> <span id="resColour">-</span></p>
            <p><strong>Year:</strong> <span id="resYear">-</span></p>
            <p><strong>Fuel Type:</strong> <span id="resFuel">-</span></p>
          </div>
          <div>
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">Status</h4>
            <p><strong>MOT Status:</strong> <span id="resMot">-</span></p>
            <p><strong>MOT Expiry:</strong> <span id="resMotExpiry">-</span></p>
            <p><strong>Tax Status:</strong> <span id="resTax">-</span></p>
            <p><strong>Tax Due:</strong> <span id="resTaxDue">-</span></p>
          </div>
          <div>
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">Technical</h4>
            <p><strong>Engine:</strong> <span id="resEngine">-</span></p>
            <p><strong>CO2:</strong> <span id="resCO2">-</span></p>
            <p><strong>Age:</strong> <span id="resAge">-</span></p>
          </div>
        </div>
      </div>
    </div>

    <p style="text-align: center; margin-top: 20px;">
      <a href="#" onclick="hideLicensePlateModal()" style="color: #999; text-decoration: none; font-size: 14px;">Close</a>
    </p>
  </div>
</div>

<script src="js/auth.js"></script>
<script>
  // Forgot Password Functions
  let resetEmail = '';

  function showForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').style.display = 'flex';
    document.getElementById('forgotStep1').style.display = 'block';
    document.getElementById('forgotStep2').style.display = 'none';
    document.getElementById('forgotEmail').value = '';
    document.getElementById('forgotMessage').style.display = 'none';
  }

  function hideForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').style.display = 'none';
  }

  function showForgotMessage(elementId, message, type) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.style.display = 'block';
    if (type === 'error') {
      el.style.background = '#ffe6e6';
      el.style.color = '#c0392b';
    } else if (type === 'success') {
      el.style.background = '#d4edda';
      el.style.color = '#155724';
    } else {
      el.style.background = '#e3f2fd';
      el.style.color = '#1976d2';
    }
  }

  async function sendResetCode() {
    const email = document.getElementById('forgotEmail').value.trim();

    if (!email) {
      showForgotMessage('forgotMessage', 'Please enter your email address.', 'error');
      return;
    }

    showForgotMessage('forgotMessage', 'Sending reset code...', 'info');

    try {
      const res = await fetch('../api/index.php?route=password/request-reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      const data = await res.json();

      if (data.success) {
        resetEmail = email;
        document.getElementById('forgotStep1').style.display = 'none';
        document.getElementById('forgotStep2').style.display = 'block';
        let msg = data.message || 'Code sent! Check your email.';
        // Show OTP code for testing if email isn't configured
        if (data.otp_code) {
          msg += ' Your code is: ' + data.otp_code;
        }
        showForgotMessage('resetMessage', msg, 'success');
      } else {
        showForgotMessage('forgotMessage', data.error || 'Failed to send reset code.', 'error');
      }
    } catch (err) {
      console.error(err);
      showForgotMessage('forgotMessage', 'Network error. Please try again.', 'error');
    }
  }

  async function resetPassword() {
    const otpCode = document.getElementById('resetOtpInput').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!otpCode || otpCode.length !== 6) {
      showForgotMessage('resetMessage', 'Please enter a valid 6-digit code.', 'error');
      return;
    }

    if (!newPassword || newPassword.length < 8) {
      showForgotMessage('resetMessage', 'Password must be at least 8 characters.', 'error');
      return;
    }

    if (newPassword !== confirmPassword) {
      showForgotMessage('resetMessage', 'Passwords do not match.', 'error');
      return;
    }

    // Client-side password validation
    if (!/[A-Z]/.test(newPassword)) {
      showForgotMessage('resetMessage', 'Password must contain at least one uppercase letter.', 'error');
      return;
    }
    if (!/[a-z]/.test(newPassword)) {
      showForgotMessage('resetMessage', 'Password must contain at least one lowercase letter.', 'error');
      return;
    }
    if (!/[0-9]/.test(newPassword)) {
      showForgotMessage('resetMessage', 'Password must contain at least one number.', 'error');
      return;
    }

    showForgotMessage('resetMessage', 'Resetting password...', 'info');

    try {
      const res = await fetch('../api/index.php?route=password/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: resetEmail,
          otp_code: otpCode,
          new_password: newPassword
        })
      });

      const data = await res.json();

      if (data.success) {
        showForgotMessage('resetMessage', 'Password reset successful! You can now login.', 'success');
        setTimeout(() => {
          hideForgotPasswordModal();
        }, 2000);
      } else {
        showForgotMessage('resetMessage', data.error || 'Failed to reset password.', 'error');
      }
    } catch (err) {
      console.error(err);
      showForgotMessage('resetMessage', 'Network error. Please try again.', 'error');
    }
  }

  async function resendResetCode() {
    if (!resetEmail) {
      showForgotMessage('resetMessage', 'Please go back and enter your email.', 'error');
      return;
    }

    showForgotMessage('resetMessage', 'Resending code...', 'info');

    try {
      const res = await fetch('../api/index.php?route=password/request-reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: resetEmail })
      });

      const data = await res.json();

      if (data.success) {
        let msg = 'New code sent! Check your email.';
        if (data.otp_code) {
          msg += ' Your code is: ' + data.otp_code;
        }
        showForgotMessage('resetMessage', msg, 'success');
      } else {
        showForgotMessage('resetMessage', data.error || 'Failed to resend code.', 'error');
      }
    } catch (err) {
      console.error(err);
      showForgotMessage('resetMessage', 'Network error. Please try again.', 'error');
    }
  }

  // Allow only numbers in OTP input
  document.getElementById('resetOtpInput').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });

  // License Plate Verification Functions
  function showLicensePlateModal() {
    document.getElementById('licensePlateModal').style.display = 'flex';
    document.getElementById('plateInput').value = '';
    document.getElementById('vehicleResults').style.display = 'none';
    document.getElementById('plateMessage').style.display = 'none';
    document.getElementById('plateInput').focus();
  }

  function hideLicensePlateModal() {
    document.getElementById('licensePlateModal').style.display = 'none';
  }

  function showPlateMessage(message, type) {
    const el = document.getElementById('plateMessage');
    el.textContent = message;
    el.style.display = 'block';
    if (type === 'error') {
      el.style.background = '#ffe6e6';
      el.style.color = '#c0392b';
    } else if (type === 'success') {
      el.style.background = '#d4edda';
      el.style.color = '#155724';
    } else {
      el.style.background = '#fff3cd';
      el.style.color = '#856404';
    }
  }

  async function verifyLicensePlate() {
    const plate = document.getElementById('plateInput').value.trim().toUpperCase().replace(/\s/g, '');

    if (!plate || plate.length < 2) {
      showPlateMessage('Please enter a valid license plate number.', 'error');
      return;
    }

    showPlateMessage('Checking vehicle details...', 'info');
    document.getElementById('vehicleResults').style.display = 'none';

    try {
      const res = await fetch('../api/index.php?route=vehicles/public-check&plate=' + encodeURIComponent(plate));
      const data = await res.json();

      if (data.success && data.vehicle) {
        displayVehicleResults(data.vehicle, plate);
        showPlateMessage('Vehicle found!', 'success');
      } else {
        showPlateMessage(data.error || 'Vehicle not found. Please check the plate number.', 'error');
      }
    } catch (err) {
      console.error('Verification error:', err);
      showPlateMessage('Failed to verify. Please try again.', 'error');
    }
  }

  function displayVehicleResults(v, plate) {
    // Format plate display
    let displayPlate = plate;
    if (plate.length >= 7) {
      displayPlate = plate.substring(0, 4) + ' ' + plate.substring(4);
    }
    document.getElementById('resultPlate').textContent = displayPlate;

    // Vehicle info
    document.getElementById('resMake').textContent = v.make || '-';
    document.getElementById('resModel').textContent = v.model || '-';
    document.getElementById('resColour').textContent = v.colour || v.color || '-';
    document.getElementById('resYear').textContent = v.yearOfManufacture || v.year || '-';
    document.getElementById('resFuel').textContent = v.fuelType || '-';

    // Status
    document.getElementById('resMot').textContent = v.motStatus || v.mot?.motStatus || '-';
    document.getElementById('resMotExpiry').textContent = v.motExpiryDate || v.mot?.motDueDate || '-';
    document.getElementById('resTax').textContent = v.taxStatus || v.tax?.taxStatus || '-';
    document.getElementById('resTaxDue').textContent = v.taxDueDate || v.tax?.taxDueDate || '-';

    // Technical
    document.getElementById('resEngine').textContent = v.engineCapacity ? v.engineCapacity + 'cc' : '-';
    document.getElementById('resCO2').textContent = v.co2Emissions ? v.co2Emissions + 'g/km' : '-';
    document.getElementById('resAge').textContent = v.vehicleAge || '-';

    // Status badges
    const badgesEl = document.getElementById('resultBadges');
    badgesEl.innerHTML = '';

    const motStatus = (v.motStatus || v.mot?.motStatus || '').toLowerCase();
    const taxStatus = (v.taxStatus || v.tax?.taxStatus || '').toLowerCase();

    const motBadge = document.createElement('span');
    motBadge.style.cssText = 'display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 5px;';
    if (motStatus.includes('valid')) {
      motBadge.style.background = '#27ae60';
      motBadge.style.color = 'white';
      motBadge.textContent = 'MOT Valid';
    } else {
      motBadge.style.background = '#e74c3c';
      motBadge.style.color = 'white';
      motBadge.textContent = 'MOT Expired';
    }
    badgesEl.appendChild(motBadge);

    const taxBadge = document.createElement('span');
    taxBadge.style.cssText = 'display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 5px;';
    if (taxStatus.includes('taxed')) {
      taxBadge.style.background = '#27ae60';
      taxBadge.style.color = 'white';
      taxBadge.textContent = 'Taxed';
    } else {
      taxBadge.style.background = '#e74c3c';
      taxBadge.style.color = 'white';
      taxBadge.textContent = 'Untaxed';
    }
    badgesEl.appendChild(taxBadge);

    document.getElementById('vehicleResults').style.display = 'block';
  }

  // Handle Enter key in plate input
  document.getElementById('plateInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      verifyLicensePlate();
    }
  });

  // Auto-format plate input
  document.getElementById('plateInput').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  });
</script>
</body>
</html>